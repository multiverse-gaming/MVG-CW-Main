

player_manager.AddValidModel( "Droideka", 		"models/starwars/stan/droidekas/droideka.mdl" );
list.Set( "PlayerOptionsModel", "Droideka", 	"models/starwars/stan/droidekas/droideka.mdl" );

local settings = {
	["name"] = "Droideka",
	["model"] = "models/starwars/stan/droidekas/droideka.mdl",
	["scale"] = 0.85,
	["developermode"] = false,
	["viewoffset"] = 68,
	["duckviewoffset"] = 50,
	["seatoffset"] = 4,
	["talkingspeed"] = 0,
	["mouthbodygroup"] = 0,
	["mouthframes"] = 0,
	["mouthstandingframe"] = 0,
	["mouthstartingframe"] = 0,
	["removeRagdoll"] = true,
	["scaleRagdoll"] = false,
	["ambientsound"] = nil,
	["hullScale"] = nil,
	["horizontalHullScale"] = nil,
}

local settings2 = {
	["name"] = "Yoda1",
	["model"] = "models/tfa/comm/gg/pm_sw_yodanojig.mdl",
	["scale"] = 0.5,
	["developermode"] = false,
	["viewoffset"] = 32,
	["duckviewoffset"] = 14,
	["seatoffset"] = 0,
	["talkingspeed"] = 0,
	["mouthbodygroup"] = 0,
	["mouthframes"] = 0,
	["mouthstandingframe"] = 0,
	["mouthstartingframe"] = 0,
	["removeRagdoll"] = true,
	["scaleRagdoll"] = true,
	["ambientsound"] = nil,
	["hullScale"] = nil,
	["horizontalHullScale"] = nil,
}

local settings3 = {
	["name"] = "Yoda2",
	["model"] = "models/tfa/comm/gg/pm_sw_yoda.mdl",
	["scale"] = nil,
	["developermode"] = false,
	["viewoffset"] = 32,
	["duckviewoffset"] = 14,
	["seatoffset"] = 0,
	["talkingspeed"] = 0,
	["mouthbodygroup"] = 0,
	["mouthframes"] = 0,
	["mouthstandingframe"] = 0,
	["mouthstartingframe"] = 0,
	["removeRagdoll"] = true,
	["scaleRagdoll"] = true,
	["ambientsound"] = nil,
	["hullScale"] = 0.4,
	["horizontalHullScale"] = nil,
}

local settings4 = {
	["name"] = "Jawa",
	["model"] = "models/jajoff/sw/jawacustom.mdl",
	["scale"] = 0.6,
	["developermode"] = false,
	["viewoffset"] = 38,
	["duckviewoffset"] = 16,
	["seatoffset"] = 4,
	["talkingspeed"] = 0,
	["mouthbodygroup"] = 0,
	["mouthframes"] = 0,
	["mouthstandingframe"] = 0,
	["mouthstartingframe"] = 0,
	["removeRagdoll"] = true,
	["scaleRagdoll"] = true,
	["ambientsound"] = nil,
	["hullScale"] = nil,
	["horizontalHullScale"] = nil,
}

local settings5 = {
	["name"] = "Wrecker",
	["model"] = "models/player/bad_batch/wrecker.mdl",
	["scale"] = 1.1,
	["developermode"] = false,
	["viewoffset"] = 70,
	["duckviewoffset"] = 31,
	["seatoffset"] = 4,
	["talkingspeed"] = 0,
	["mouthbodygroup"] = 0,
	["mouthframes"] = 0,
	["mouthstandingframe"] = 0,
	["mouthstartingframe"] = 0,
	["removeRagdoll"] = false,
	["scaleRagdoll"] = true,
	["ambientsound"] = nil,
	["hullScale"] = 1.05,
	["horizontalHullScale"] = nil,
}

local settings6 = {
	["name"] = "Wookiee1",
	["model"] = "models/grand/wookie_wild.mdl",
	["scale"] = 1.2,
	["developermode"] = false,
	["viewoffset"] = 76,
	["duckviewoffset"] = 33,
	["seatoffset"] = 4,
	["talkingspeed"] = 0,
	["mouthbodygroup"] = 0,
	["mouthframes"] = 0,
	["mouthstandingframe"] = 0,
	["mouthstartingframe"] = 0,
	["removeRagdoll"] = false,
	["scaleRagdoll"] = true,
	["ambientsound"] = nil,
	["hullScale"] = nil,
	["horizontalHullScale"] = nil,
}

local settings7 = {
	["name"] = "Wookiee2",
	["model"] = "models/grand/wookie.mdl",
	["scale"] = 1.2,
	["developermode"] = false,
	["viewoffset"] = 76,
	["duckviewoffset"] = 33,
	["seatoffset"] = 4,
	["talkingspeed"] = 0,
	["mouthbodygroup"] = 0,
	["mouthframes"] = 0,
	["mouthstandingframe"] = 0,
	["mouthstartingframe"] = 0,
	["removeRagdoll"] = false,
	["scaleRagdoll"] = true,
	["ambientsound"] = nil,
	["hullScale"] = nil,
	["horizontalHullScale"] = nil,
}

local settings8 = {
	["name"] = "Massif",
	["model"] = "models/mrpounder1/player/massif.mdl",
	["scale"] = nil,
	["developermode"] = false,
	["viewoffset"] = 25,
	["duckviewoffset"] = 15,
	["seatoffset"] = 4,
	["talkingspeed"] = 0,
	["mouthbodygroup"] = 0,
	["mouthframes"] = 0,
	["mouthstandingframe"] = 0,
	["mouthstartingframe"] = 0,
	["removeRagdoll"] = false,
	["scaleRagdoll"] = false,
	["ambientsound"] = nil,
	["hullScale"] = 0.5,
	["horizontalHullScale"] = nil,
}

local settings9 = {
	["name"] = "Ahsoka1",
	["model"] = "models/plo/ahsoka/ahsoka_s7.mdl",
	["scale"] = 0.95,
	["developermode"] = false,
	["viewoffset"] = 61,
	["duckviewoffset"] = 27,
	["seatoffset"] = 4,
	["talkingspeed"] = 0,
	["mouthbodygroup"] = 0,
	["mouthframes"] = 0,
	["mouthstandingframe"] = 0,
	["mouthstartingframe"] = 0,
	["removeRagdoll"] = false,
	["scaleRagdoll"] = true,
	["ambientsound"] = nil,
	["hullScale"] = nil,
	["horizontalHullScale"] = nil,
}

local settings10 = {
	["name"] = "Ahsoka2",
	["model"] = "models/tfa/comm/gg/pm_sw_ahsoka_v1.mdl",
	["scale"] = 0.9,
	["developermode"] = false,
	["viewoffset"] = 58,
	["duckviewoffset"] = 25,
	["seatoffset"] = 4,
	["talkingspeed"] = 0,
	["mouthbodygroup"] = 0,
	["mouthframes"] = 0,
	["mouthstandingframe"] = 0,
	["mouthstartingframe"] = 0,
	["removeRagdoll"] = false,
	["scaleRagdoll"] = true,
	["ambientsound"] = nil,
	["hullScale"] = nil,
	["horizontalHullScale"] = nil,
}

local settings11 = {
	["name"] = "Ahsoka3",
	["model"] = "models/tfa/comm/gg/pm_sw_ahsoka_v2.mdl",
	["scale"] = 0.95,
	["developermode"] = false,
	["viewoffset"] = 61,
	["duckviewoffset"] = 27,
	["seatoffset"] = 4,
	["talkingspeed"] = 0,
	["mouthbodygroup"] = 0,
	["mouthframes"] = 0,
	["mouthstandingframe"] = 0,
	["mouthstartingframe"] = 0,
	["removeRagdoll"] = false,
	["scaleRagdoll"] = true,
	["ambientsound"] = nil,
	["hullScale"] = nil,
	["horizontalHullScale"] = nil,
}

local mEnt = FindMetaTable("Entity")

mEnt.NewSetModel = mEnt.NewSetModel || mEnt.SetModel

function mEnt:SetModel(model)

	self.NewSetModel(self, model)
	if(self:IsPlayer()) then
		hook.Run("SPM_ModelChange", self)
	end

end

if(SERVER) then

	util.AddNetworkString("CustomResetModel")
	util.AddNetworkString("CustomRescaleModel")

else
	net.Receive("CustomResetModel", function()
		local ply = LocalPlayer()
		if(IsValid(ply)) then
			ply:SetModelScale(1)
			ply:ResetHull()
			ply:SetViewOffset(Vector(0, 0, 64))
			ply:SetViewOffsetDucked(Vector(0, 0, 28))
		end

	end)

	net.Receive("CustomRescaleModel", function()
		local ply = LocalPlayer()
		if(IsValid(ply)) then
			local model = net.ReadString()
			local tab = SPM_Pool[model]

			if (tab["scale"] ~= nil) then
				ply:SetModelScale(tab["scale"])
			end

			if (tab["hullScale"] ~= nil) then
				local horizontalHullSize = 16
				if (tab["horizontalHullScale"] ~= nil) then
					horizontalHullSize = horizontalHullSize * tab["horizontalHullScale"]
				end
				ply:SetHull(Vector(-horizontalHullSize, -horizontalHullSize, 0), Vector(horizontalHullSize, horizontalHullSize, 72 * tab["hullScale"]))
				ply:SetHullDuck(Vector(-horizontalHullSize, -horizontalHullSize, 0), Vector(horizontalHullSize, horizontalHullSize, 36 * tab["hullScale"]))
			end

			ply:SetViewOffset(Vector(0, 0, tab["viewoffset"]))
			ply:SetViewOffsetDucked(Vector(0, 0, tab["duckviewoffset"]))
		end

	end)
end

if(SERVER) then

	hook.Add("SPM_ModelChange", "SpawningFunction", function(ply)

		timer.Simple(0, function()
			if(SPM_Pool[ply:GetModel()] == nil) then
				ply:SetModelScale(1)
				ply:ResetHull()
				ply:SetViewOffset(Vector(0, 0, 64))
				ply:SetViewOffsetDucked(Vector(0, 0, 28))

				net.Start("CustomResetModel")
				net.Send(ply)
			end
		end)

		timer.Simple(FrameTime(), function()
			if(SPM_Pool[ply:GetModel()] ~= nil) then
				local tab = SPM_Pool[ply:GetModel()]

				if (tab["scale"] ~= nil) then
					ply:SetModelScale(tab["scale"])
				end

				ply:SetViewOffset(Vector(0, 0, tab["viewoffset"]))
				ply:SetViewOffsetDucked(Vector(0, 0, tab["duckviewoffset"]))

				if (tab["hullScale"] ~= nil) then
					local horizontalHullSize = 16
					if (tab["horizontalHullScale"] ~= nil) then
						horizontalHullSize = horizontalHullSize * tab["horizontalHullScale"]
					end
					ply:SetHull(Vector(-horizontalHullSize, -horizontalHullSize, 0), Vector(horizontalHullSize, horizontalHullSize, 72 * tab["hullScale"]))
					ply:SetHullDuck(Vector(-horizontalHullSize, -horizontalHullSize, 0), Vector(horizontalHullSize, horizontalHullSize, 36 * tab["hullScale"]))
				end
				
				net.Start("CustomRescaleModel")
				net.WriteString( ply:GetModel() )
				net.Send(ply)
			end
		end)

	end)

end


hook.Add("PlayerEnteredVehicle", "CustomVehicleOffset", function(ply, veh)

	if(ply:InVehicle()) then
		if(ply:GetModel() == settings["model"]) then
			ply:SetPos(Vector(0, 0, settings["seatoffset"]))
		end
	end

end)

hook.Add("PostPlayerDeath", "CustomRemoveScaleDeathRagdoll", function(ply)
	
	if(SPM_Pool[ply:GetModel()] ~= nil) then
		local tab = SPM_Pool[ply:GetModel()]
		if(tab["removeRagdoll"]) then
			local rag = ply:GetRagdollEntity()
			if(IsValid(rag)) then
				rag:Remove()
			end
		elseif (tab["scaleRagdoll"]) then 
			local rag = ply:GetRagdollEntity()
			if(IsValid(rag)) then
				rag:SetModelScale(tab["scale"])
			end
		end
	end

end)

--[[hook.Add("EntityTakeDamage", "ReducePlayerKnockbackPerModel", function(target, dmginfo)
    -- Check if the entity taking damage is a player
    if target:IsPlayer() then
		local tab = SPM_Pool[target:GetModel()]
		if(SPM_Pool[target:GetModel()] ~= nil) then
			local scale = tab["scale"]
			if scale ~= nil && scale < 1 then
				if (!target._TakingReducedKnockbackDamage) then
					target._TakingReducedKnockbackDamage = true
					local mulitplier = scale * scale * scale
					local newDamage = dmginfo:GetDamage()
					dmginfo:SetDamage(mulitplier * dmginfo:GetDamage())
					local newDamageInfo = DamageInfo()
					local Attacker = dmginfo:GetAttacker()
					newDamageInfo:SetAttacker(Attacker)
					newDamageInfo:SetDamage(newDamage - dmginfo:GetDamage())
					newDamageInfo:SetDamageType( dmginfo:GetDamageType() )
					target:TakeDamageInfo(newDamageInfo)
					target._TakingReducedKnockbackDamage = false
				end
			end
		end
    end
end)]]

hook.Add("PostDrawTranslucentRenderables", settings["name"].."DeveloperMode", function()

	local ply = LocalPlayer()
	if(settings["developermode"] == true) then
		if(ply:GetModel() == settings["model"]) then
			local ePos = ply:EyePos()
			local eOffset = (ePos - ply:GetPos()).Z

			if(eOffset == settings["duckviewoffset"]) then
			end

			render.SetColorMaterial()
			render.DrawBox(ply:GetPos() , Angle(0, 0, 0), min, max, Color(255, 0, 0, 150))
			render.DrawBox(ply:EyePos(), Angle(0, 0, 0), Vector(min.X, min.Y, -1), Vector(max.X, max.Y, 1), Color(255, 255, 0, 100))
		end
	end

end)

hook.Add("Initialize", "CustomSetPool", function()
	SPM_Pool = {}
	timer.Simple(FrameTime(), function()
		SPM_Pool[settings["model"]] = settings
		SPM_Pool[settings2["model"]] = settings2
		SPM_Pool[settings3["model"]] = settings3
		SPM_Pool[settings4["model"]] = settings4
		SPM_Pool[settings5["model"]] = settings5
		SPM_Pool[settings6["model"]] = settings6
		SPM_Pool[settings7["model"]] = settings7
		SPM_Pool[settings8["model"]] = settings8
		SPM_Pool[settings9["model"]] = settings9
		SPM_Pool[settings10["model"]] = settings10
		SPM_Pool[settings11["model"]] = settings11
	end)
end)
