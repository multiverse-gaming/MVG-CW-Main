/*

 ██████╗██████╗ ███████╗ █████╗ ████████╗███████╗██████╗     ██████╗ ██╗   ██╗    ███╗   ███╗ █████╗ ██████╗  █████╗ ███╗   ██╗███████╗ ██████╗ 
██╔════╝██╔══██╗██╔════╝██╔══██╗╚══██╔══╝██╔════╝██╔══██╗    ██╔══██╗╚██╗ ██╔╝    ████╗ ████║██╔══██╗██╔══██╗██╔══██╗████╗  ██║╚══███╔╝██╔═══██╗
██║     ██████╔╝█████╗  ███████║   ██║   █████╗  ██║  ██║    ██████╔╝ ╚████╔╝     ██╔████╔██║███████║██████╔╝███████║██╔██╗ ██║  ███╔╝ ██║   ██║
██║     ██╔══██╗██╔══╝  ██╔══██║   ██║   ██╔══╝  ██║  ██║    ██╔══██╗  ╚██╔╝      ██║╚██╔╝██║██╔══██║██╔══██╗██╔══██║██║╚██╗██║ ███╔╝  ██║   ██║
╚██████╗██║  ██║███████╗██║  ██║   ██║   ███████╗██████╔╝    ██████╔╝   ██║       ██║ ╚═╝ ██║██║  ██║██║  ██║██║  ██║██║ ╚████║███████╗╚██████╔╝
 ╚═════╝╚═╝  ╚═╝╚══════╝╚═╝  ╚═╝   ╚═╝   ╚══════╝╚═════╝     ╚═════╝    ╚═╝       ╚═╝     ╚═╝╚═╝  ╚═╝╚═╝  ╚═╝╚═╝  ╚═╝╚═╝  ╚═══╝╚══════╝ ╚═════╝ 

------------------------------------------------------------------------------------------------------------------------------------------------------

██████╗  ██████╗     ███╗   ██╗ ██████╗ ████████╗    ██████╗ ███████╗██╗   ██╗██████╗ ██╗      ██████╗  █████╗ ██████╗                               
██╔══██╗██╔═══██╗    ████╗  ██║██╔═══██╗╚══██╔══╝    ██╔══██╗██╔════╝██║   ██║██╔══██╗██║     ██╔═══██╗██╔══██╗██╔══██╗                              
██║  ██║██║   ██║    ██╔██╗ ██║██║   ██║   ██║       ██████╔╝█████╗  ██║   ██║██████╔╝██║     ██║   ██║███████║██║  ██║                              
██║  ██║██║   ██║    ██║╚██╗██║██║   ██║   ██║       ██╔══██╗██╔══╝  ██║   ██║██╔═══╝ ██║     ██║   ██║██╔══██║██║  ██║                              
██████╔╝╚██████╔╝    ██║ ╚████║╚██████╔╝   ██║       ██║  ██║███████╗╚██████╔╝██║     ███████╗╚██████╔╝██║  ██║██████╔╝                              
╚═════╝  ╚═════╝     ╚═╝  ╚═══╝ ╚═════╝    ╚═╝       ╚═╝  ╚═╝╚══════╝ ╚═════╝ ╚═╝     ╚══════╝ ╚═════╝ ╚═╝  ╚═╝╚═════╝                               

██╗███╗   ██╗     █████╗ ███╗   ██╗██╗   ██╗    ███████╗██╗  ██╗ █████╗ ██████╗ ███████╗     ██████╗ ██████╗     ███████╗ ██████╗ ██████╗ ███╗   ███╗
██║████╗  ██║    ██╔══██╗████╗  ██║╚██╗ ██╔╝    ██╔════╝██║  ██║██╔══██╗██╔══██╗██╔════╝    ██╔═══██╗██╔══██╗    ██╔════╝██╔═══██╗██╔══██╗████╗ ████║
██║██╔██╗ ██║    ███████║██╔██╗ ██║ ╚████╔╝     ███████╗███████║███████║██████╔╝█████╗      ██║   ██║██████╔╝    █████╗  ██║   ██║██████╔╝██╔████╔██║
██║██║╚██╗██║    ██╔══██║██║╚██╗██║  ╚██╔╝      ╚════██║██╔══██║██╔══██║██╔═══╝ ██╔══╝      ██║   ██║██╔══██╗    ██╔══╝  ██║   ██║██╔══██╗██║╚██╔╝██║
██║██║ ╚████║    ██║  ██║██║ ╚████║   ██║       ███████║██║  ██║██║  ██║██║     ███████╗    ╚██████╔╝██║  ██║    ██║     ╚██████╔╝██║  ██║██║ ╚═╝ ██║
╚═╝╚═╝  ╚═══╝    ╚═╝  ╚═╝╚═╝  ╚═══╝   ╚═╝       ╚══════╝╚═╝  ╚═╝╚═╝  ╚═╝╚═╝     ╚══════╝     ╚═════╝ ╚═╝  ╚═╝    ╚═╝      ╚═════╝ ╚═╝  ╚═╝╚═╝     ╚═╝

-------------------------------------------------------- DO NOT REUPLOAD IN ANY SHAPE OR FORM -------------------------------------------------------- 
-------------------------------------------------------- DO NOT REUPLOAD IN ANY SHAPE OR FORM -------------------------------------------------------- 
-------------------------------------------------- IF YOU EDIT ANYTHING YOU ARE VOID OF MY SUPPORT --------------------------------------------------- 
-------------------------------------------------- IF YOU EDIT ANYTHING YOU ARE VOID OF MY SUPPORT --------------------------------------------------- 

*/

AddCSLuaFile()

CreateConVar( 'sk_mas_fistsofreprsial_enabled', '1', { FCVAR_ARCHIVE, FCVAR_REPLICATED, FCVAR_SERVER_CAN_EXECUTE } )
CreateConVar( 'sk_mas_fistsofreprsial_adminonly', '0', { FCVAR_ARCHIVE, FCVAR_SERVER_CAN_EXECUTE } )
CreateConVar( 'sk_mas_fistsofreprisal_infinitecharge', '0', { FCVAR_ARCHIVE, FCVAR_REPLICATED, FCVAR_SERVER_CAN_EXECUTE }, "Enable infinite charge for this SWEP" )
CreateConVar( 'sk_mas_fistsofreprisal_nocooldown', '0', { FCVAR_ARCHIVE, FCVAR_REPLICATED, FCVAR_SERVER_CAN_EXECUTE }, "Disable cooldowns for this SWEP" )
CreateConVar( 'sk_mas_lagcompensate_npc', '1', { FCVAR_ARCHIVE, FCVAR_REPLICATED, FCVAR_SERVER_CAN_EXECUTE }, "Leave this active unless it is confirmed to be conflicting with another addon or if you are maxing your CPU and RAM and need every scrap. Removing this greatly affects player perspectives and should be re-enabled ASAP." )
CreateConVar( 'sk_mas_setmaxhealth_onspawn', '1', { FCVAR_ARCHIVE, FCVAR_REPLICATED, FCVAR_SERVER_CAN_EXECUTE }, "Leave this active unless it is actually conflicting with another addon. Disabling this results in healing abilities only going to 100 HP (the default max health) unless defined by another addon. DarkRP DOES NOT set MAX HEALTH by default, hence why I made this code!" )

	Maranzos_AbilitySWEPs = Maranzos_AbilitySWEPs or {}
		
		if SERVER then
			cvars.AddChangeCallback( "sk_mas_fistsofreprisal_infinitecharge", function( convar_name, value_old, value_new )
				Maranzos_AbilitySWEPs.FoR_InfUlt	= tobool( GetConVarNumber( "sk_mas_fistsofreprisal_infinitecharge" ) )
			end )
			cvars.AddChangeCallback( "sk_mas_bloodmagessoul_nocooldown", function( convar_name, value_old, value_new )
				Maranzos_AbilitySWEPs.FoR_NoCD	= tobool( GetConVarNumber( "sk_mas_fistsofreprisal_nocooldown" ) )
			end )
		end
	
if (CLIENT) then

print("\n")
print("[MAS] Maranzo\'s Ability SWEPs: Fists of Reprisal")
print("[MAS]: Options Loaded")
	
	MASconvar_drawhud = CreateClientConVar( 'cl_mas_drawhud', '1' )
	MASconvar_crosshairon = CreateClientConVar( 'cl_mas_crosshairon', '1' )
	MASconvar_preventbinds = CreateClientConVar( 'cl_mas_preventbinds', '1' )
	
	Maranzos_AbilitySWEPs.keyconfigs = Maranzos_AbilitySWEPs.keyconfigs or {}
	
	
-------------------------------------------------------------------
-- Define General Use Functions
	
	local function AS_SaveStoredConfig()
		file.Write( 'mas/maranzo_as_bindings.txt', util.TableToJSON( Maranzos_AbilitySWEPs.keyconfigs, true ) )
		print("[MAS]: Saved binds to Maranzo_AS_bindings.txt \n")
	end // end Save Config


-- Default Binds

	local function AS_DefaultKeyConfigs() 
		print("[MAS]: Default Keybinds Set")
		local KB = {} -- Maranzos_AbilitySWEPs.keyconfigs or {} -- Key Bindings
		
		KB["Binds"] = {
			[ 1 ]	=	input.LookupBinding( "+attack", true ),
			[ 2 ]	=	input.LookupBinding( "+attack2", true ),
			[ 3 ]	=	KEY_F,
			[ 4 ]	=	KEY_C,
			[ 5 ]	=	KEY_T,
			[ 6 ]	=	MOUSE_MIDDLE,
		}
		
		// Add a table with just the Btn names first
		KB["Btn"] = {}
		for k, v in pairs(KB["Binds"]) do
			KB["Btn"][v] = tonumber(k)
		end
		
		// Create a proper display name for these keys
		KB[ 1 ] = string.upper( language.GetPhrase( KB["Binds"][ 1 ] ) ) -- Attack
		KB[ 2 ] = string.upper( language.GetPhrase( KB["Binds"][ 2 ] ) ) -- Abil 1
		KB[ 3 ] = string.upper( language.GetPhrase( input.GetKeyName( KB["Binds"][ 3 ] ) ) ) -- Abil 2
		KB[ 4 ] = string.upper( language.GetPhrase( input.GetKeyName( KB["Binds"][ 4 ] ) ) ) -- Abil 3
		KB[ 5 ] = string.upper( language.GetPhrase( input.GetKeyName( KB["Binds"][ 5 ] ) ) ) -- Ult
		KB[ 6 ] = string.upper( language.GetPhrase( input.GetKeyName( KB["Binds"][ 6 ] ) ) ) -- Abil Select
		if KB[ 1 ] == "MOUSE1" then KB[ 1 ] = "LMB" end
		if KB[ 2 ] == "MOUSE2" then KB[ 2 ] = "RMB" end
		
		table.Empty( Maranzos_AbilitySWEPs.keyconfigs )
		table.Merge( Maranzos_AbilitySWEPs.keyconfigs, KB )
		AS_SaveStoredConfig()
		
	end // end Default Key Config
	
	local function AS_LoadStoredConfig()
		if file.Exists( 'mas/maranzo_as_bindings.txt', 'DATA' ) then
			local fl = file.Read( 'mas/maranzo_as_bindings.txt', 'DATA' )
			if fl then // Confirming if there is a File
				fl = util.JSONToTable( fl )
				if istable( fl ) then
					print("[MAS]: Binding Table Loaded \n")
					table.Empty( Maranzos_AbilitySWEPs.keyconfigs )
					table.Merge( Maranzos_AbilitySWEPs.keyconfigs, fl )
				end
			else // Can't read that shit
				print("[MAS]: Binding Table Not Found \n")
				AS_DefaultKeyConfigs()
			end // end If File Read
		else // No File Found
			file.CreateDir( "mas" )
			print("[MAS]: No Bindings file found \n")
			AS_DefaultKeyConfigs()
		end
	end // end Load Stored Config
	AS_LoadStoredConfig() -- load it
	
	local function UI_MakeBinder( name, ability )
		name:SetTall( 50 )
		if Maranzos_AbilitySWEPs.keyconfigs[ ability ] then
			name:SetValue( Maranzos_AbilitySWEPs.keyconfigs["Binds"][ ability ] )
		end
		
		function name:OnChange( num )
			local lastBtn = Maranzos_AbilitySWEPs.keyconfigs["Binds"][ ability ]
			Maranzos_AbilitySWEPs.keyconfigs["Btn"][ lastBtn ] = false -- Disable Prev Btn
			Maranzos_AbilitySWEPs.keyconfigs["Binds"][ ability ] = num -- Set new key as binded ( "Btn" is what counts )
			Maranzos_AbilitySWEPs.keyconfigs["Btn"][ num ] = ability -- Enable new number
			Maranzos_AbilitySWEPs.keyconfigs[ ability ] = string.upper( language.GetPhrase( input.GetKeyName( num ) ) ) -- Set Display Text
			AS_SaveStoredConfig()
		end
		
		return name
	end // end Fn UI_MakeBinder
-- Tool Options

	hook.Add( 'PopulateToolMenu', 'Maranzo_AS_FistsOfReprisal', function()
		spawnmenu.AddToolMenuOption( 'Options',
			'Ability SWEPs',
			'Maranzo_AS_FistsOfReprisal',
			'MAS: Fists of Reprisal',
			'',
			'',
			function( pnl )
				pnl:ControlHelp( '' )
				pnl:Help( 'Maranzo\'s Ability SWEPs: Fists of Reprisal' )
				pnl:ControlHelp( 'Created by Maranzo. I hope you enjoy it!' )
				pnl:ControlHelp( '' )

				local btnBug = vgui.Create( 'DButton' )
				btnBug:SetText( 'REPORT A BUG' )
				btnBug.DoClick = function()
					gui.OpenURL( 'http://steamcommunity.com/workshop/filedetails/discussion/935300356/1291817208502447989/' )
				end
				btnBug:SetTall( 25 )
				pnl:AddItem( btnBug )

				local btnMore = vgui.Create( 'DButton' )
				btnMore:SetText( 'View More by Maranzo' )
				btnMore.DoClick = function()
					gui.OpenURL( 'http://steamcommunity.com/id/Maranzo/myworkshopfiles/?appid=4000' )
				end
				btnMore:SetTall( 50 )
				pnl:AddItem( btnMore )

				local btnRate = vgui.Create( 'DButton' )
				btnRate:SetText( 'Rate this SWEP' )
				btnRate.DoClick = function()
					gui.OpenURL( 'http://steamcommunity.com/sharedfiles/filedetails/?id=935300356' )
				end
				btnRate:SetTall( 50 )
				pnl:AddItem( btnRate )
				pnl:ControlHelp( 'Rate this SWEP and find the Official Suggestions page from here!' )
				pnl:ControlHelp( '' )
				
				pnl:CheckBox( 'Draw HUD', 'cl_mas_drawhud' )
				pnl:ControlHelp( 'Enable / Disable the showing of Ability icons, Binds, and Combo when the SWEP is out' )
				
				pnl:CheckBox( 'Show Crosshair', 'cl_mas_crosshairon' )
				pnl:ControlHelp( 'Enable / Disable the crosshair. Note: You must switch to another weapon for this to take effect. In Singleplayer you must strip the weapon / die.' )
				
				pnl:CheckBox( 'Prevent Basic Binds ( Flashlight, Menu, CMenu )', 'cl_mas_preventbinds' )
				pnl:ControlHelp( 'Prevent your prop spawn menu, context menu, and flashlight from working while the SWEP is out. By Default this is on to prevent overlap.' )
				pnl:ControlHelp( '' )
				
				pnl:Help( 'Attack: Punch' )
				pnl:Dock( FILL )
				local MAS_AA = vgui.Create( "DButton" )
				MAS_AA:SetTall( 50 )
				MAS_AA:SetText( Maranzos_AbilitySWEPs.keyconfigs[ 1 ] )
				pnl:AddItem( MAS_AA )
				pnl:ControlHelp( 'This is your +attack key \n( Usually your Left Mouse Button )' )
				MAS_AA:SetDisabled( true )
				
				pnl:Help( 'Ability: Scorn Mark' )
				pnl:Dock( FILL )
				local MAS_AbScorn = vgui.Create( "DButton" )
				MAS_AbScorn:SetTall( 50 )
				MAS_AbScorn:SetText( Maranzos_AbilitySWEPs.keyconfigs[ 2 ] )
				pnl:AddItem( MAS_AbScorn )
				pnl:ControlHelp( 'This is your +attack2 key \n( Usually your Right Mouse Button )' )
				MAS_AbScorn:SetDisabled( true )
				
				pnl:Help( 'Ability: Vengeful Leap' )
				local MAS_AbVenge = vgui.Create( "DBinder" )
				pnl:AddItem( UI_MakeBinder( MAS_AbVenge, 3 ) )
				
				pnl:Help( 'Ability: Veteran\'s Strength' )
				local MAS_AbVet = vgui.Create( "DBinder" )
				pnl:AddItem( UI_MakeBinder( MAS_AbVet, 4 ) )
				
				pnl:Help( 'Ability: Meteor Dive' )
				local MAS_AbMet = vgui.Create( "DBinder" )
				pnl:AddItem( UI_MakeBinder( MAS_AbMet, 5 ) )
				
				pnl:Help( 'Ability Selection' )
				local MAS_AbSel = vgui.Create( "DBinder" )
				pnl:AddItem( UI_MakeBinder( MAS_AbSel, 6 ) )
				pnl:ControlHelp( '' )
				
				pnl:Help( 'Holster Weapon' )
				pnl:Dock( FILL )
				local MAS_Holst = vgui.Create( "DBinder" )
				MAS_Holst:SetTall( 50 )
				MAS_Holst:SetText( string.upper( language.GetPhrase( input.LookupBinding( "+Reload", true ) ) ) )
				pnl:AddItem( MAS_Holst )
				pnl:ControlHelp( 'This is your +reload key \n( Usually your "R" Button )' )
				MAS_Holst:SetDisabled( true )
				
				local def = vgui.Create( 'DButton' )
				def:SetText( 'RESTORE DEFAULTS' )
				def.DoClick = function()
					Derma_Query( [[Are you sure you want to restore default settings?
					This cannot be undone!]],
						'Maranzo\'s Ability SWEPs: Defaults',
						'Yes, I\'m sure',
						function()
							-- Console: Client Side
							RunConsoleCommand( 'cl_mas_drawhud', '1' )
							RunConsoleCommand( 'cl_mas_crosshairon', '1' )
							RunConsoleCommand( 'cl_mas_preventbinds', '1' )
							
							-- Abilities: Key Binds
							AS_DefaultKeyConfigs()
							MAS_AA:SetText( Maranzos_AbilitySWEPs.keyconfigs["Binds"][ 1 ] )
							MAS_AbScorn:SetText( Maranzos_AbilitySWEPs.keyconfigs["Binds"][ 2 ] )
							MAS_AbVenge:SetValue( Maranzos_AbilitySWEPs.keyconfigs["Binds"][ 3 ] )
							MAS_AbVet:SetValue( Maranzos_AbilitySWEPs.keyconfigs["Binds"][ 4 ] )
							MAS_AbMet:SetValue( Maranzos_AbilitySWEPs.keyconfigs["Binds"][ 5 ] )
							MAS_AbSel:SetValue( Maranzos_AbilitySWEPs.keyconfigs["Binds"][ 6 ] )
							
							Derma_Message( 'Settings have been successfully restored to defaults.', 'Maranzo\'s Ability SWEPs: Defaults', 'OK' )
						end,
						'No, abort action' )
				end
				def:SetTall( 25 )
				pnl:AddItem( def )
				pnl:ControlHelp( '' )

				if LocalPlayer():IsAdmin() then
					pnl:Help( 'Admin Options' )
					pnl:CheckBox( 'Spawnable SWEP', 'sk_mas_fistsofreprsial_enabled' )
					pnl:ControlHelp( 'Console variant: sk_mas_fistsofreprsial_enabled. Note: This will take effect on map change. It may still be spawned through the give weapon command.' )
					pnl:CheckBox( 'Admin Spawnable only', 'sk_mas_fistsofreprsial_adminonly' )
					pnl:ControlHelp( 'Console variant: sk_mas_fistsofreprsial_adminonly. Note: Map change, or you must die / drop / strip it & spawn it again in order for this to take effect' )
					pnl:CheckBox( 'Cheat: Infinite Ultimate Charge' , 'sk_mas_fistsofreprisal_infinitecharge' )
					pnl:ControlHelp( 'Console variant: sk_mas_fistsofreprisal_infinitecharge. Note: Change is immediate.' )
					pnl:CheckBox( 'Cheat: No Cooldowns', 'sk_mas_fistsofreprisal_nocooldown' )
					pnl:ControlHelp( 'Console variant: sk_mas_fistsofreprisal_infinitecharge. Note: You must die/ drop / strip it & spawn it again in order for this to take effect.' )
					pnl:ControlHelp( '' )
					
					pnl:Help( 'How awesome is this slider?' )
					pnl:NumSlider( 'Awesomeness', '', 1, 10, 0 )
					pnl:NumSlider( 'Slidiness', '', 1, 100, 0 )
					pnl:ControlHelp( '' )
					pnl:ControlHelp( '' )
				end // end If Admin
				
				if LocalPlayer():IsSuperAdmin() then
					pnl:Help( 'Super-Admin Options' )
					pnl:ControlHelp( "Note, each of these options can have a huge impact on player perspectives. It is recommended to leave the options below enabled." )
					pnl:CheckBox( 'Record Max Health on Spawn', 'sk_mas_setmaxhealth_onspawn' )
					pnl:ControlHelp( "Console variant: sk_mas_setmaxhealth_onspawn. Note: Map change only. Leave this active unless it is actually conflicting with another addon. Disabling this results in healing abilities only going to 100 HP (the default max health) unless defined by another addon. DarkRP DOES NOT set MAX HEALTH by default, hence why I made this code!" ) 
					pnl:CheckBox( 'NPC Lag Compensation', 'sk_mas_lagcompensate_npc' )
					pnl:ControlHelp( "Console variant: sk_mas_lagcompensate_npc. Note: Map change only. Keep this on even if NPC's aren't currently in use. Leave this active unless it is confirmed to be conflicting with another addon or if you are maxing your CPU and RAM and need every scrap. Removing this greatly affects player perspectives and should be re-enabled ASAP." )
					pnl:ControlHelp( '' )
					pnl:ControlHelp( '' )
					
				end // end If SuperAdmin
				
			end ) // end F'n
			
		print("MAS: Populated Tool Menu")
	end ) // end Hook Tool Menu


end // end If Client