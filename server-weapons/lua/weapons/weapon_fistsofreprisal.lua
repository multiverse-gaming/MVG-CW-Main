/*

 ██████╗██████╗ ███████╗ █████╗ ████████╗███████╗██████╗     ██████╗ ██╗   ██╗    ███╗   ███╗ █████╗ ██████╗  █████╗ ███╗   ██╗███████╗ ██████╗ 
██╔════╝██╔══██╗██╔════╝██╔══██╗╚══██╔══╝██╔════╝██╔══██╗    ██╔══██╗╚██╗ ██╔╝    ████╗ ████║██╔══██╗██╔══██╗██╔══██╗████╗  ██║╚══███╔╝██╔═══██╗
██║     ██████╔╝█████╗  ███████║   ██║   █████╗  ██║  ██║    ██████╔╝ ╚████╔╝     ██╔████╔██║███████║██████╔╝███████║██╔██╗ ██║  ███╔╝ ██║   ██║
██║     ██╔══██╗██╔══╝  ██╔══██║   ██║   ██╔══╝  ██║  ██║    ██╔══██╗  ╚██╔╝      ██║╚██╔╝██║██╔══██║██╔══██╗██╔══██║██║╚██╗██║ ███╔╝  ██║   ██║
╚██████╗██║  ██║███████╗██║  ██║   ██║   ███████╗██████╔╝    ██████╔╝   ██║       ██║ ╚═╝ ██║██║  ██║██║  ██║██║  ██║██║ ╚████║███████╗╚██████╔╝
 ╚═════╝╚═╝  ╚═╝╚══════╝╚═╝  ╚═╝   ╚═╝   ╚══════╝╚═════╝     ╚═════╝    ╚═╝       ╚═╝     ╚═╝╚═╝  ╚═╝╚═╝  ╚═╝╚═╝  ╚═╝╚═╝  ╚═══╝╚══════╝ ╚═════╝ 

------------------------------------------------------------------------------------------------------------------------------------------------------

██████╗  ██████╗     ███╗   ██╗ ██████╗ ████████╗    ██████╗ ███████╗██╗   ██╗██████╗ ██╗      ██████╗  █████╗ ██████╗                               
██╔══██╗██╔═══██╗    ████╗  ██║██╔═══██╗╚══██╔══╝    ██╔══██╗██╔════╝██║   ██║██╔══██╗██║     ██╔═══██╗██╔══██╗██╔══██╗                              
██║  ██║██║   ██║    ██╔██╗ ██║██║   ██║   ██║       ██████╔╝█████╗  ██║   ██║██████╔╝██║     ██║   ██║███████║██║  ██║                              
██║  ██║██║   ██║    ██║╚██╗██║██║   ██║   ██║       ██╔══██╗██╔══╝  ██║   ██║██╔═══╝ ██║     ██║   ██║██╔══██║██║  ██║                              
██████╔╝╚██████╔╝    ██║ ╚████║╚██████╔╝   ██║       ██║  ██║███████╗╚██████╔╝██║     ███████╗╚██████╔╝██║  ██║██████╔╝                              
╚═════╝  ╚═════╝     ╚═╝  ╚═══╝ ╚═════╝    ╚═╝       ╚═╝  ╚═╝╚══════╝ ╚═════╝ ╚═╝     ╚══════╝ ╚═════╝ ╚═╝  ╚═╝╚═════╝                               

██╗███╗   ██╗     █████╗ ███╗   ██╗██╗   ██╗    ███████╗██╗  ██╗ █████╗ ██████╗ ███████╗     ██████╗ ██████╗     ███████╗ ██████╗ ██████╗ ███╗   ███╗
██║████╗  ██║    ██╔══██╗████╗  ██║╚██╗ ██╔╝    ██╔════╝██║  ██║██╔══██╗██╔══██╗██╔════╝    ██╔═══██╗██╔══██╗    ██╔════╝██╔═══██╗██╔══██╗████╗ ████║
██║██╔██╗ ██║    ███████║██╔██╗ ██║ ╚████╔╝     ███████╗███████║███████║██████╔╝█████╗      ██║   ██║██████╔╝    █████╗  ██║   ██║██████╔╝██╔████╔██║
██║██║╚██╗██║    ██╔══██║██║╚██╗██║  ╚██╔╝      ╚════██║██╔══██║██╔══██║██╔═══╝ ██╔══╝      ██║   ██║██╔══██╗    ██╔══╝  ██║   ██║██╔══██╗██║╚██╔╝██║
██║██║ ╚████║    ██║  ██║██║ ╚████║   ██║       ███████║██║  ██║██║  ██║██║     ███████╗    ╚██████╔╝██║  ██║    ██║     ╚██████╔╝██║  ██║██║ ╚═╝ ██║
╚═╝╚═╝  ╚═══╝    ╚═╝  ╚═╝╚═╝  ╚═══╝   ╚═╝       ╚══════╝╚═╝  ╚═╝╚═╝  ╚═╝╚═╝     ╚══════╝     ╚═════╝ ╚═╝  ╚═╝    ╚═╝      ╚═════╝ ╚═╝  ╚═╝╚═╝     ╚═╝

-------------------------------------------------------- DO NOT REUPLOAD IN ANY SHAPE OR FORM -------------------------------------------------------- 
-------------------------------------------------------- DO NOT REUPLOAD IN ANY SHAPE OR FORM -------------------------------------------------------- 
-------------------------------------------------- IF YOU EDIT ANYTHING YOU ARE VOID OF MY SUPPORT --------------------------------------------------- 
-------------------------------------------------- IF YOU EDIT ANYTHING YOU ARE VOID OF MY SUPPORT --------------------------------------------------- 

*/
AddCSLuaFile()
AddCSLuaFile( "autorun/cl_mas_fistsofreprisal_options.lua" )
AddCSLuaFile( "autorun/sh_mas_fistsofreprisal_fonts.lua" )
include( "autorun/cl_mas_fistsofreprisal_options.lua" )
include( "autorun/sh_mas_fistsofreprisal_fonts.lua" )

if (CLIENT) then

	SWEP.PrintName			= "MAS: Fists of Reprisal"
	SWEP.Author				= "Maranzo"
	SWEP.Category 			= "MVG - Melee Equipment"
	SWEP.Instructions		= [[
	LMB: Attack
	RMB: Ability 1
	"F" Key: Ability 2
	"C" Key: Ability 3
	Mouse3: Ability Selection
	
	Deal more damage and attack faster by getting more combos and alternating hands!
	]]
	
end // end If Client

SWEP.ViewModel			=	Model( "models/weapons/c_arms.mdl" )
SWEP.UseHands			=	true
SWEP.WorldModel			=	""
SWEP.HoldType			=	"fist"
SWEP.ViewModelFOV 		= 	54
SWEP.Spawnable 			= 	GetConVar( "sk_mas_fistsofreprsial_enabled" ):GetBool()
SWEP.AdminOnly 			= 	GetConVar( "sk_mas_fistsofreprsial_adminonly" ):GetBool()

SWEP.Weight				= 	5
SWEP.AutoSwitchTo		= 	true
SWEP.AutoSwitchFrom		= 	false
SWEP.ShouldDropOnDie	=	false

SWEP.Slot				= 	1 -- Secondary weapon
SWEP.SlotPos			= 	0 -- Takes up the beginning slot
SWEP.DrawAmmo			= 	false -- Do not show ammo on HUD
SWEP.DrawCrosshair		= 	true

SWEP.Primary.ClipSize		= 	-1 -- Infinite Ammo
SWEP.Primary.DefaultClip	= 	-1 -- Starts Infinite
SWEP.Primary.Automatic		= 	false -- Not automatic
SWEP.Primary.Ammo			= 	"none" -- "none" bc no ammo needed
SWEP.Primary.Damage			= 	30
SWEP.Primary.DamageUppercut	= 	45

SWEP.Secondary.ClipSize		= 	-1 -- Infinite again
SWEP.Secondary.DefaultClip	= 	-1
SWEP.Secondary.Automatic	= 	false -- Not automatic
SWEP.Secondary.Ammo			= 	"none" -- No ammo needed

SWEP.SwingDelay1			=	0.3
SWEP.SwingDelay2			=	0.2
SWEP.ModDelay				=	1
SWEP.ModDmg					=	1
SWEP.Hit					= 	false
SWEP.HitTime				= 	CurTime()
SWEP.HitDistance		 	= 	48

// Abilities

ASWEP_Ability_AutoAttack		= 1
ASWEP_Ability_ScornMark			= 2
ASWEP_Ability_VengefulLeap		= 3
ASWEP_Ability_VeteranStrength	= 4
ASWEP_Ability_Select			= 6

SWEP.AbilityTable = {
	["Equipped"] = {
		[ASWEP_Ability_AutoAttack]		= {
			["Category"] = "AutoAttack",
			["Name"] = "Fists of Reprisal",
			["Description"] = "Beat your enemy down! Gain health, extra damage, and attack speed with each hit." },
		[ASWEP_Ability_ScornMark]		= { ["Category"] = "Ability 1", ["Name"] = "Scorn Mark", ["Description"] = "Land this right jab on your enemy to slow and weigh them down. A marked target will take extra damage and heal you significantly for each blow." },
		[ASWEP_Ability_VengefulLeap]	= { ["Category"] = "Ability 2", ["Name"] = "Vengeful Leap", ["Description"] = "Leap into the air and send everything flying on impact." },
		[ASWEP_Ability_VeteranStrength]	= {	["Category"] = "Ability 3", ["Name"] = "Veteran Strength", ["Description"] = "Regain your strength! Every hit deals more damage, and you receive more health back for each blow." },
	},
}

-------------------------------------------------------------------

local ability_icons = {
	[ASWEP_Ability_AutoAttack] 		= { def = Material( 'hud/maranzo_abilityswep/icon_aa_swordswing.png' ), 	cast = Material( 'hud/maranzo_abilityswep/icon_aa_swordswing.png' ) },
	[ASWEP_Ability_ScornMark] 		= { def = Material( 'hud/maranzo_abilityswep/icon_scornmark.png' ), 		cast = Material( 'hud/maranzo_abilityswep/icon_scornMark_cast.png' ) },
	[ASWEP_Ability_VengefulLeap] 	= { def = Material( 'hud/maranzo_abilityswep/icon_vengefulleap.png' ), 		cast = Material( 'hud/maranzo_abilityswep/icon_vengefulLeap_cast.png' ) },
	[ASWEP_Ability_VeteranStrength]	= { def = Material( 'hud/maranzo_abilityswep/icon_veteranstrength.png' ), 	cast = Material( 'hud/maranzo_abilityswep/icon_veteranStrength_cast.png' ) },
}

local function DrawCenteredRect( x, y, w, h )
	surface.DrawTexturedRect( x - w / 2, y - h / 2, w, h )
end

	
if (CLIENT) then
	killicon.Add( "weapon_fistsofreprisal", "icons/fistsofreprisal_killicon", color_white )
	local WepSelectIcon = Material( "icons/fistsofreprisal_weaponselect.png" )
	local Size = 128
	
	function SWEP:DrawWeaponSelection( x, y, w, h, a )
		surface.SetDrawColor( 255, 255, 255, a )
		surface.SetMaterial( WepSelectIcon )
	
		--render.PushFilterMag( TEXFILTER.ANISOTROPIC )
		--render.PushFilterMin( TEXFILTER.ANISOTROPIC )
	
		surface.DrawTexturedRect( x + ( ( w - Size ) / 2 ), y + 2, Size, Size )
	
		--render.PopFilterMag()
		--render.PopFilterMin()
		-- Draw weapon info box
		self:PrintWeaponInfo( x + w + 20, y + h * 0.95, a )
	end
end

-------------------------------------------------------------------
-- Precache Misc Sounds

local SwingSound = Sound( "WeaponFrag.Throw" )
local HitSound = Sound( "Flesh.ImpactHard" )

--------------------------------------------------------------------
-- Define Local Functions

// Keys down for SinglePlayer
local keysDown = {}

// Effect F'n for think
local function playEffect( origin, entity, flags, effectstr, iterations, scale, magnitude, r1, r2, rz )
	
	if !iterations then iterations = 1 end
	if !scale then scale = 1 end
	if !magnitude then magnitude = 1 end
	if !r1 then r1 = 0 r2 = 0 end
	if !r2 then r2 = r1 end
		local TF_ed = EffectData()
		TF_ed:SetOrigin( origin )
		TF_ed:SetEntity( entity )
		TF_ed:SetFlags( flags )
		TF_ed:SetScale( scale )
		TF_ed:SetMagnitude( magnitude )
	for i=1, iterations do
		local randVec = !rz and Vector( math.random( -r1, r2 ), math.random( -r1, r2 ), 0 ) or Vector( math.random( -r1, r2 ), math.random( -r1, r2 ), math.random( -r1, r2 ) )
		TF_ed:SetOrigin( origin + randVec )
		util.Effect( effectstr, TF_ed, true, true )
	end
	
end

--------------------------------------------------------------------
-- Define SWEP Functions

local MAS = {}
function SWEP:Initialize()
	self.Spawnable			= 	GetConVar( "sk_mas_fistsofreprsial_enabled" ):GetBool()
	self.AdminOnly			= 	GetConVar( "sk_mas_fistsofreprsial_adminonly" ):GetBool()
	
	if Maranzos_AbilitySWEPs then 
		Maranzos_AbilitySWEPs.FoR_InfUlt= tobool( GetConVarNumber( "sk_mas_fistsofreprisal_infinitecharge" ) )
		Maranzos_AbilitySWEPs.FoR_NoCD	= tobool( GetConVarNumber( "sk_mas_fistsofreprisal_nocooldown" ) )
		
		table.Merge( MAS, Maranzos_AbilitySWEPs ) -- Merge that shit rather than reference it
	end
	
	MAS.IsCasting					=	false
	MAS.Ability 					=	{}
	MAS.Ability.AA 					= 	{}	-- Auto Attack
	MAS.Ability.ScornMk 			= 	{}	-- Scorn Mark
	MAS.Ability.VengLp 				= 	{}	-- Vengeful Leap
	MAS.Ability.VetSt 				= 	{}	-- Veteran Strength
	MAS.Ability.MeteorDv 			= 	{}	-- Ultimate: Meteor Dive
	
	-- Ultimate: Charge up your health & shield, then launch yourself and crash into the ground
	MAS.Ability.MeteorDv.Damage			=	200
	MAS.Ability.MeteorDv.MaxCharge		=	100
	MAS.Ability.MeteorDv.Heal			=	10	-- per 0.1s * 10
	MAS.Ability.MeteorDv.Arm			=	10	-- per 0.1s * 10
	MAS.Ability.MeteorDv.Sound1			= 	Sound( "ambience/particle_suck1.wav" )
	MAS.Ability.MeteorDv.Sound2			= 	Sound( "npc/antlion/digup1.wav" )
	MAS.Ability.MeteorDv.SoundLand		= 	Sound( "physics/concrete/boulder_impact_hard4.wav" )
	MAS.Ability.MeteorDv.SoundLand2		= 	Sound( "phx/explode01.wav" )
	
	-- ScornMark: Mark Target if hit (Hit Trace), slows & make them take extra damage from your attacks ( +15 dmg ) that partially heals you ( 10% )
	MAS.Ability.ScornMk.Cooldown	=	10	-- seconds
	MAS.Ability.ScornMk.CDMissed	=	3	-- seconds
	MAS.Ability.ScornMk.Damage		=	35
	MAS.Ability.ScornMk.DmgMul		=	1.3
	MAS.Ability.ScornMk.LSMul		=	0.3
	MAS.Ability.ScornMk.Duration	=	3	-- seconds
	MAS.Ability.ScornMk.SoundHit	=	Sound( "npc/antlion_guard/antlion_guard_shellcrack2.wav" )	-- seconds
	
	-- Vengeful Leap: Leap in direction facing & slow targets in area upon landing
	MAS.Ability.VengLp.Cooldown		=	10	-- seconds
	MAS.Ability.VengLp.Damage		=	20
	MAS.Ability.VengLp.ForceMul		=	850
	MAS.Ability.VengLp.Sound1		= 	Sound( "physics/concrete/concrete_break2.wav" )
	MAS.Ability.VengLp.SoundLand	= 	Sound( "physics/concrete/boulder_impact_hard3.wav" )
	
	-- Veteran Strength: Heal yourself & gain extra damage
	MAS.Ability.VetSt.Cooldown		=	18	-- seconds
	MAS.Ability.VetSt.DmgMul		=	1.3
	MAS.Ability.VetSt.Duration		=	4
	MAS.Ability.VetSt.Heal			=	75
	MAS.Ability.VetSt.LSMul			=	0.3	-- HP LS
	MAS.Ability.VetSt.ALS			=	2	-- armor LS
	MAS.Ability.VetSt.Sound1		=	Sound( "npc/combine_gunship/ping_search.wav" ) -- Activate Sound
	MAS.Ability.VetSt.SoundHit		=	Sound( "npc/strider/strider_step5.wav" ) -- Currently not in use
	
	if Maranzos_AbilitySWEPs.FoR_NoCD then
		MAS.Ability.ScornMk.Cooldown	=	1
		MAS.Ability.VengLp.Cooldown		=	1
		MAS.Ability.VetSt.Cooldown		=	1
	end
	
	
	local ply = self.Owner
	
	if (CLIENT) then
		self.DrawCrosshair		= 	GetConVar( "cl_mas_crosshairon" ):GetBool()
		self.KB = Maranzos_AbilitySWEPs.keyconfigs
		
		// Define a table of instructions
		self.Instr = {}
		self.Instr["H1"] = self.KB[ 1 ] .. " : "
		self.Instr["H2"] = self.KB[ 2 ] .. " : "
		self.Instr["H3"] = self.KB[ 3 ] .. " : "
		self.Instr["H4"] = self.KB[ 4 ] .. " : "
		self.Instr["H5"] = self.KB[ 5 ] .. " : "
		self.Instr["H6"] = self.KB[ 6 ] .. " : "
		self.Instr["1"] = "Attack"
		self.Instr["2"] = "Scorn Mark"
		self.Instr["3"] = "Vengeful Leap"
		self.Instr["4"] = "Veteran Strength"
		self.Instr["5"] = "Ultimate: Meteor Dive"
		self.Instr["6"] = "Ability Selection"
		self.Instr["7"] = "\n".. "Deal more damage and attack faster by getting more combos!"
		self.Instr["8"] = "\n".. "Check the Options menu to Rebind Abilities and Enable Menu & Flashlight use."
	
		// Run when key pressed
		if !game.SinglePlayer() then
			hook.Add( "PlayerButtonDown", "MAS.Keybind.FistsOfReprisal" .. ply:EntIndex(), function( ply, btn )
				local Wep = ply:GetActiveWeapon()
				
				if ( ply:IsValid() and ply:Alive() and Wep:IsValid() and Wep:GetClass() == "weapon_fistsofreprisal" ) then
					
					if self.KB and self.KB["Btn"][btn] and IsFirstTimePredicted() then 
						-- AutoAttack & Ability #1:Scorn Mark are bound to +attack & +attack2 by default & won't trigger anything here.
						if !vgui.CursorVisible() then
							
							if self.KB["Btn"][btn] == ASWEP_Ability_VengefulLeap then 
							// Abil 2: Vengeful Leap
								if ( self:GetIsCasting() or self:GetA2_CD() != 0 ) then 
									return 
								end
								local ability = ASWEP_Ability_VengefulLeap
								local CD = MAS.Ability.VengLp.Cooldown
								self:SetA2_Active( true )
								self:SetIsCasting( true )
								self:SetA2_CD( CD )
							
								-- Launch!
								local vel = ply:GetAimVector()
								local forcemul = MAS.Ability.VengLp.ForceMul
								if vel.z > 0.5 then vel.z = vel.z * 0.8 end
								ply:SetPos( ply:GetPos() + Vector( 0, 0, 3 ) )
								ply:SetVelocity( vel * forcemul + ply:GetUp() * 30 )
								
								net.Start( "Maranzo_AbilitySWEP_FistsOfReprisal_Cast" )
								net.WriteInt( ability, 4 )
								net.SendToServer()
								
							elseif self.KB["Btn"][btn] == ASWEP_Ability_VeteranStrength then 
							// Abil 3: Veteran Strength
								if ( self:GetIsCasting() or self:GetA3_CD() != 0 ) then 
									return 
								end
								local CD = MAS.Ability.VetSt.Cooldown
								self:SetA3_Active( true )
								self:SetIsCasting( true )
								self:SetA3_CD( CD )
								
								local ability = ASWEP_Ability_VeteranStrength
								
								net.Start( "Maranzo_AbilitySWEP_FistsOfReprisal_Cast" )
								net.WriteInt( ability, 4 )
								net.SendToServer()
							
							end // end Key Check
						end // end if cursor visible
						
						if self.KB["Btn"][btn] == ASWEP_Ability_Select then
						// Ability Selection
							self:DrawAbilitySelection()
							
						end // end Key check, cursor visible OK
						
					end // end Btn Pushed Check
				end // end if ply & alive & weapon
			end) // end Hook
		else // if game is SinglePlayer
			-- do nothing
		end // end if SinglePlayer
	
		// Run when key pressed
		hook.Add( "PlayerBindPress", "MAS.Keybind.FistsOfReprisal" .. ply:EntIndex(), function( ply, bind, down )
			local Wep = ply:GetActiveWeapon()
			if ( ply and ply:IsValid() and ply:Alive() and MASconvar_preventbinds:GetBool() and Wep:IsValid() and ply:GetActiveWeapon():GetClass() == "weapon_fistsofreprisal" ) then
				if ( string.find( bind, "impulse 100" ) or string.find( bind, "+menu" ) or string.find( bind, "+menu_context" ) ) then 
					return true
				end // end string find 
			end // end if Valid
		end) // end Hook
		
	end // end If Client
	
	self:SetHoldType( "fist" )
	if (SERVER) then
		self:SetCharge( 0 )
	end

end

function SWEP:DrawAbilitySelection()
	
	if ( MAS.Editor != nil ) then
		MAS.Editor:Remove()
		MAS.Editor = nil
	elseif !vgui.CursorVisible() then
		local x = ScrW()
		local y = ScrH()
		local BGColor = Color( 0, 130, 200, 200 )
		local FGColor = Color(50, 50, 50, 150)
		local BorderColor = Color( 0, 100, 165, 255 )
		local TColor1 = Color(255, 255, 255, 255)
		local TColor2 = Color(255, 180, 20, 255)
		local TColor3 = Color(255, 240, 220, 255)
		local TColorBG = Color(60, 60, 60, 255)
		local OvlColor = Color(255, 255, 0, 100)
		MAS.Editor = vgui.Create( "DFrame" ) //Create a Frame to contain everything.
		MAS.Editor:SetTitle( "" )
		MAS.Editor:SetSize( x, y )
		MAS.Editor:Center()
		MAS.Editor:SetVisible( true )
		MAS.Editor:ShowCloseButton( false )
		function MAS.Editor:Paint()
			surface.SetDrawColor( BGColor )
			surface.DrawRect( 0, 0, x, y )
			surface.SetDrawColor( BorderColor )
			for i=1, 6 do
				surface.DrawOutlinedRect( 0+i, 0+i, x - i*2, y - i*2 )
			end
			local Tx = x/2
			local Ty = y/20
			draw.SimpleText("Ability Selection", "MaranzoAbil_UltimateFont", Tx + 2, Ty + 2, TColorBG, TEXT_ALIGN_CENTER, TEXT_ALIGN_CENTER)
			draw.SimpleText("Ability Selection", "MaranzoAbil_UltimateFont", Tx, Ty, TColor1, TEXT_ALIGN_CENTER, TEXT_ALIGN_CENTER)
		end
			
		local DButton = vgui.Create( "DButton", MAS.Editor )
		local size = 64
		local border = 12
		DButton:SetSize( size, size )
		DButton:SetPos( x - size - border, y - size - border )
		DButton:SetText( "Close" )
		DButton:SetTextColor( TColor1 )
		DButton:SetFontInternal( "MaranzoAbil_DefaultFont" )
		DButton:SetExpensiveShadow( 1, TColorBG )
		DButton.DoClick = function()
			MAS.Editor:Remove()
			MAS.Editor = nil
		end
		local Dw, Dh
		function DButton:Paint( w, h)
			Dw = w
			Dh = h
			draw.RoundedBox( 8, 0, 0, Dw, Dh, BorderColor )
			draw.RoundedBox( 8, 0, 0, Dw - 4, Dh - 4, FGColor )
		end
		
		
		MAS.Editor.Scroll = vgui.Create( "DScrollPanel", MAS.Editor ) //Create the Scroll panel
		MAS.Editor.Scroll:SetSize( x - 24, y - y/5 )
		MAS.Editor.Scroll:SetPos( 12, y/20 )
		
		MAS.Editor.List = vgui.Create( "DIconLayout", MAS.Editor.Scroll )
		MAS.Editor.List:SetSize( x - 30, y - y/5 )
		MAS.Editor.List:SetPos( 0, 0 )
		MAS.Editor.List:SetSpaceX( 5 )
		MAS.Editor.List:SetSpaceY( 10 )
		
		// Create list
		for k, v in ipairs( self.AbilityTable["Equipped"] ) do -- ipairs is a temp fix until I add additional abilities
			local ListItem = MAS.Editor.List:Add( "DPanel" ) //Add DPanel to the DIconLayout
			ListItem:SetSize( MAS.Editor.List:GetWide(), y/7 ) //Set the size of it
			function ListItem:Paint( w, h )
				local drawColor = Color( 255, 255, 255, 255 )
				local ability = k
				local material = ability_icons[ ability ] and ability_icons[ ability ].def or ability_icons[ ASWEP_Ability_AutoAttack ].def
				local size = 64
				local Tx = w/50
				local Ty = 2
				surface.SetMaterial( material )
				surface.SetDrawColor( drawColor )
				DrawCenteredRect( size/2 + Tx, h/2, size, size )
				draw.SimpleText( v["Category"], "MaranzoAbil_DefaultFont", Tx +2, 2 +2, TColorBG, TEXT_ALIGN_LEFT, TEXT_ALIGN_LEFT )
				draw.SimpleText( v["Category"], "MaranzoAbil_DefaultFont", Tx, 2, TColor2, TEXT_ALIGN_LEFT, TEXT_ALIGN_LEFT )
				draw.SimpleText( v["Name"], "MaranzoAbil_DefaultFont", Tx +2, h - 28 +2, TColorBG, TEXT_ALIGN_LEFT, TEXT_ALIGN_LEFT )
				draw.SimpleText( v["Name"], "MaranzoAbil_DefaultFont", Tx, h - 28, TColor1, TEXT_ALIGN_LEFT, TEXT_ALIGN_LEFT )
			end // end ListItem Paint
			
			local DLabel = vgui.Create( "DLabel", ListItem )
			local w = ListItem:GetWide()
			local h = ListItem:GetTall()
			local Tx, Sx
			if x > 1200 then
				if x > 1350 then Tx = w/7 Sx = w - Tx * 2.5
				else Tx = w/6 Sx = w - Tx * 2 end
			else Tx = w/4 Sx = w - Tx end
			
			local Ty = 12
			DLabel:SetSize( Sx, h - 14 )
			DLabel:SetPos( Tx, Ty )
			DLabel:SetText( v["Description"] )
			DLabel:SetContentAlignment( 4 )
			DLabel:SetTextColor( TColor3 )
			DLabel:SetTextInset( 0, 0 )
			DLabel:SetFontInternal( "MaranzoAbil_DefaultFont" )
			DLabel:SetWrap( true )
			DLabel:SetExpensiveShadow( 1, TColorBG )
			
		end // end For Loop List Creation
		
	end
	
end

function SWEP:DrawHUD()
	
	// Setup Var's used across the board
	local Combo = self:GetCombo()
	local Charge = self:GetCharge()
	local ability
	local ACTIVE
	local CD
	
	if !MASconvar_drawhud:GetBool() then return end
	// Ability Icon Draw
	local drawColor = ( prohibited ) and Color( 100, 100, 100, 255 ) or Color( 255, 255, 255, 255 ) -- shortened If statement	
	local size = ( menushown && ability == menu_ability ) and 128 or 64 // 128 | 64
	local ultsize = ( menushown && ability == menu_ability ) and 128 or 128 // 128 | 64
	
	-- positioning
	local x = ScrW()/2 -- Ult (Center)
	local y = ScrH() - 70
	local dif = 110
	local x0 = x - dif * 1.7 -- AA
	local x1 = x - dif
	local x2 = x + dif
	local x3 = x + dif * 1.7
	local TxtY = y + size * 0.65
	local Txt2Y = y + size * 0.65 + 2
	local TColor = Color(255, 255, 255, 255)
	local T2Color = Color(20, 20, 20, 255)
	
	// Auto-Attack
	ability = ASWEP_Ability_AutoAttack
	ACTIVE = self:GetAA_Active()
	CD = self:GetAA_CD()
	drawColor = ( CD > 0 ) and Color( 100, 100, 100, 255 ) or Color( 255, 255, 255, 255 ) -- shortened If statement
	surface.SetMaterial( ability_icons[ ability ].def )
	surface.SetDrawColor( drawColor )
	DrawCenteredRect( x0, y, size, size )
	draw.SimpleText( self.KB[ ability ], "MaranzoAbil_DefaultFont", x0 + 1, Txt2Y, T2Color, TEXT_ALIGN_CENTER, TEXT_ALIGN_CENTER)
	draw.SimpleText( self.KB[ ability ], "MaranzoAbil_DefaultFont", x0, TxtY, TColor, TEXT_ALIGN_CENTER, TEXT_ALIGN_CENTER)
	
	// Ability 1
	ability = ASWEP_Ability_ScornMark
	ACTIVE = self:GetA1_Active()
	CD = self:GetA1_CD()
	if !ACTIVE then // Not Active
		surface.SetMaterial( ability_icons[ ability ].def )
		
		if CD > 0 then
			drawColor = Color( 100, 100, 100, 255 )
			surface.SetDrawColor( drawColor )
			DrawCenteredRect( x1, y, size, size )
			draw.SimpleText( CD, "MaranzoAbil_DefaultFont", x1, y, TColor, TEXT_ALIGN_CENTER, TEXT_ALIGN_CENTER)
		else
			drawColor = Color( 255, 255, 255, 255 )
			surface.SetDrawColor( drawColor )
			DrawCenteredRect( x1, y, size, size )
		end
		
	else // Active
		drawColor = Color( 255, 255, 255, 255 ) -- shortened If statement
		surface.SetMaterial( ability_icons[ ability ].cast )
		surface.SetDrawColor( drawColor )
		DrawCenteredRect( x1, y, size, size )
	end // end if Active
	
	draw.SimpleText( self.KB[ ability ], "MaranzoAbil_DefaultFont", x1 + 1, Txt2Y, T2Color, TEXT_ALIGN_CENTER, TEXT_ALIGN_CENTER)
	draw.SimpleText( self.KB[ ability ], "MaranzoAbil_DefaultFont", x1, TxtY, TColor, TEXT_ALIGN_CENTER, TEXT_ALIGN_CENTER)
	
	
	// Ability 2
	ability = ASWEP_Ability_VengefulLeap
	ACTIVE = self:GetA2_Active()
	CD = self:GetA2_CD()
	if !ACTIVE then // Not Active
		surface.SetMaterial( ability_icons[ ability ].def )
		
		if CD > 0 then
			drawColor = Color( 100, 100, 100, 255 )
			surface.SetDrawColor( drawColor )
			DrawCenteredRect( x2, y, size, size )
			draw.SimpleText( CD, "MaranzoAbil_DefaultFont", x2, y, TColor, TEXT_ALIGN_CENTER, TEXT_ALIGN_CENTER)
		else
			drawColor = Color( 255, 255, 255, 255 )
			surface.SetDrawColor( drawColor )
			DrawCenteredRect( x2, y, size, size )
		end
		
	else // Active
		drawColor = Color( 255, 255, 255, 255 )
		surface.SetMaterial( ability_icons[ ability ].cast )
		surface.SetDrawColor( drawColor )
		DrawCenteredRect( x2, y, size, size )
	end // end if Active
	
	draw.SimpleText( self.KB[ ability ], "MaranzoAbil_DefaultFont", x2 + 1, Txt2Y, T2Color, TEXT_ALIGN_CENTER, TEXT_ALIGN_CENTER)
	draw.SimpleText( self.KB[ ability ], "MaranzoAbil_DefaultFont", x2, TxtY, TColor, TEXT_ALIGN_CENTER, TEXT_ALIGN_CENTER)
	
	
	// Ability 3
	ability = ASWEP_Ability_VeteranStrength
	ACTIVE = self:GetA3_Active()
	CD = self:GetA3_CD()
	if !ACTIVE then // Not Active
		surface.SetMaterial( ability_icons[ ability ].def )
		
		if CD > 0 then
			drawColor = Color( 100, 100, 100, 255 )
			surface.SetDrawColor( drawColor )
			DrawCenteredRect( x3, y, size, size )
			draw.SimpleText( CD, "MaranzoAbil_DefaultFont", x3, y, TColor, TEXT_ALIGN_CENTER, TEXT_ALIGN_CENTER)
		else
			drawColor = Color( 255, 255, 255, 255 )
			surface.SetDrawColor( drawColor )
			DrawCenteredRect( x3, y, size, size )
		end
		
	else // Active
		drawColor = Color( 255, 255, 255, 255 )
		surface.SetMaterial( ability_icons[ ability ].cast )
		surface.SetDrawColor( drawColor )
		DrawCenteredRect( x3, y, size, size )
	end // end if Active
	
	draw.SimpleText( self.KB[ ability ], "MaranzoAbil_DefaultFont", x3 + 1, Txt2Y, T2Color, TEXT_ALIGN_CENTER, TEXT_ALIGN_CENTER)
	draw.SimpleText( self.KB[ ability ], "MaranzoAbil_DefaultFont", x3, TxtY, TColor, TEXT_ALIGN_CENTER, TEXT_ALIGN_CENTER)
	
	
----------------------------
	// Variables
	-- local ChargeColor = Color(40,200,255,180) - Nice Blue
	local ChargeColor = Color(255,255,255,255)
	local FullChargeColor = Color(255,200,40,180)
	local x = ScrW() * 0.5
	local y = ScrH() * 0.5
	
	// Combo HUD Draw
	if Combo > 2 then
		local color = Color(255,200,40,180)
		local ComboText = Combo .. " (" .. 1 + Combo/20 .. ")"
		local ComboAlpha = 255
		
		if Combo > 9 then
			if Combo > 20 then
				for i = 1, 2 do
					local Rand1 = math.random(-2, 2)
					local Rand2 = math.random(-2, 2)
					draw.SimpleText("Combo:", "MaranzoAbil_DefaultFont", x + Rand1 + 2, y + 30 + Rand2 + 2, Color(60, 60, 60, ComboAlpha * 1), TEXT_ALIGN_CENTER, TEXT_ALIGN_CENTER)
					draw.SimpleText("Combo:", "MaranzoAbil_DefaultFont", x + Rand1, y + 30 + Rand2, Color(255, 20, 20, ComboAlpha * 1), TEXT_ALIGN_CENTER, TEXT_ALIGN_CENTER)
				end
			else // not Combo > 20
				ComboAlpha = Lerp(0.1, ComboAlpha, 0)
					local Rand1 = math.random(-1, 1)
					local Rand2 = math.random(-1, 1)
					draw.SimpleText("Combo:", "MaranzoAbil_DefaultFont", x + Rand1 + 2, y + 30 + Rand2 + 2, Color(60, 60, 60, ComboAlpha * 1), TEXT_ALIGN_CENTER, TEXT_ALIGN_CENTER)
					draw.SimpleText("Combo:", "MaranzoAbil_DefaultFont", x + Rand1, y + 30 + Rand2, Color(255, 255, 255, ComboAlpha * 1), TEXT_ALIGN_CENTER, TEXT_ALIGN_CENTER)
			end
		else // not Combo > 9
			ComboAlpha = Lerp(0.1, ComboAlpha, 0)
			draw.SimpleText("Combo", "MaranzoAbil_DefaultFont", x, y + 30, Color(255, 255, 255, ComboAlpha), TEXT_ALIGN_CENTER, TEXT_ALIGN_CENTER)
					end
			draw.SimpleText(ComboText, "MaranzoAbil_DefaultFont", x, y + 50, color, TEXT_ALIGN_CENTER, TEXT_ALIGN_CENTER)
	end // end Combo
	
	local y = ScrH() - 120
	
	// Charge HUD Draw
	if Charge >= MAS.Ability.MeteorDv.MaxCharge then
		-- do nothing
	elseif !ACTIVE then // not max charge & not active
		-- Draw Charge %
		local ChargeText = Charge.."%"
		draw.SimpleText(ChargeText, "MaranzoAbil_UltimateFont", x + 12, ScrH() - 98, Color( 20, 20, 20, 255 ), TEXT_ALIGN_CENTER, TEXT_ALIGN_CENTER)
		draw.SimpleText(ChargeText, "MaranzoAbil_UltimateFont" , x + 10, ScrH() - 100, ChargeColor, TEXT_ALIGN_CENTER, TEXT_ALIGN_CENTER)
	end
	
	return true
  end

// Specifically draw crosshair
function SWEP:DoDrawCrosshair( x, y )	
	-- little box
    surface.SetDrawColor(0, 0, 0, 125)
    surface.DrawRect(x - 3, y - 3, 6, 6)
    
    surface.SetDrawColor(255, 255, 255, 150)
    surface.DrawRect( x - 2, y - 2, 4, 4)
	return true
end

function SWEP:SetupDataTables()

	self:NetworkVar( "Float", 0, "NextMeleeAttack" )
	self:NetworkVar( "Float", 1, "NextIdle" )
	self:NetworkVar( "Float", 2, "AA_CD" )
	self:NetworkVar( "Float", 3, "A1_CD" )
	self:NetworkVar( "Float", 4, "A2_CD" )
	self:NetworkVar( "Float", 5, "A3_CD" )
	
	self:NetworkVar( "Int", 0, "Combo" )
	self:NetworkVar( "Int", 1, "Charge" )
	
	self:NetworkVar( "String", 0, "Ability" )
	
	self:NetworkVar( "Bool", 0, "AA_Active" )
	self:NetworkVar( "Bool", 1, "A1_Active" )
	self:NetworkVar( "Bool", 2, "A2_Active" )
	self:NetworkVar( "Bool", 3, "A3_Active" )
	self:NetworkVar( "Bool", 4, "AU_Active" )
	self:NetworkVar( "Bool", 5, "IsCasting" )
	self:NetworkVar( "Bool", 6, "CastOnLand" )

end

function SWEP:UpdateNextIdle( ply )
	
	local ply = ply or self.Owner
	local vm = ply:GetViewModel()
	self:SetNextIdle( CurTime() + vm:SequenceDuration() / vm:GetPlaybackRate() )

end

local reloadToggle = false
local reloadTime = CurTime()
function SWEP:Reload()
	
	local curtime = CurTime()
	if curtime < reloadTime then return end
	reloadTime = curtime + 0.5
	if self:GetAU_Active() or self:GetA2_Active() or self:GetA3_Active() then return end
	
	-- Visual FX
	local anim					=	reloadToggle and "fists_draw" or "fists_holster"
	local vm 					= 	self.Owner:GetViewModel()
	local speed 				= 	GetConVarNumber( "sv_defaultdeployspeed" ) or 1
	local Duration				= 	vm:SequenceDuration() / speed
	local CD					=	reloadToggle and Duration or 1000000000
	local HoldType				=	reloadToggle and "fist" or "normal"
	vm:SendViewModelMatchingSequence( vm:LookupSequence( anim ) )
	self:SetHoldType( HoldType )
	self:SetNextPrimaryFire( curtime + CD )
	self:SetNextSecondaryFire( curtime + CD )
	self:SetNextIdle( curtime + CD )
	
	reloadToggle = !reloadToggle
	self:SetIsCasting( reloadToggle )
	
	return false
end

--
-- Called when the left mouse button is pressed
--
function SWEP:PrimaryAttack( right )
	
	local ply = self.Owner
	
	self:SetAA_Active( true )
	self.Owner:SetAnimation( PLAYER_ATTACK1 )
	self:SetNextMeleeAttack( CurTime() + 0.2 * self.ModDelay )
	local combo = self:GetCombo()
	
	local anim = "fists_left"
	if ( right ) then 	// Ability 1: Scorn Mark
		anim = "fists_right"
		CD = self.SwingDelay2 * self.ModDelay
		self:SetAA_CD( CD )
		timer.Simple( CD, function()
			if self:IsValid() and !self:GetAA_Active() then self:SetAA_CD( 0 ) end
		end)
		self:SetNextPrimaryFire( CurTime() + CD )
		self:SetNextSecondaryFire( CurTime() + self.SwingDelay1 * self.ModDelay )
		
	else // Not A1, is AA
		local rand = math.Round(CurTime()) / 2
		if ( math.Round(rand) == rand ) then anim = "fists_left" else anim = "fists_right" end
		CD = self.SwingDelay1 * self.ModDelay
		self:SetAA_CD( CD )
		timer.Simple( CD, function()
			if self:IsValid() and !self:GetAA_Active() then self:SetAA_CD( 0 ) end
		end)
		self:SetNextPrimaryFire( CurTime() + CD )
		self:SetNextSecondaryFire( CurTime() + CD )
	end // end if AA
	
	if ( combo > 2 ) then
		if (combo / 3) == math.floor(combo / 3) then anim = "fists_uppercut" end 
		self.ModDmg = 1 + combo/20
		if	( combo > 5 ) then
			if	( combo > 10 ) then
				if ( combo > 20 ) then
					self.ModDelay = 0.7
				else // not > 20
					self.ModDelay = 0.8
				end
			else // not > 10
				self.ModDelay = 0.9
			end
		end
	end
	
	local vm = self.Owner:GetViewModel()
	vm:SendViewModelMatchingSequence( vm:LookupSequence( anim ) )
	self:EmitSound( SwingSound )
	self:UpdateNextIdle()

end

function SWEP:SecondaryAttack()
	
	if !IsFirstTimePredicted() then return end
	local A1_CD = self:GetA1_CD()
	local AA_CD = self:GetAA_CD()
	
	if ( A1_CD != 0 ) then return end
	
	local CD = MAS.Ability.ScornMk.Cooldown
	self:SetA1_Active( true )
	self:SetA1_CD( CD )
	self:PrimaryAttack( true )
	
end

function SWEP:DealDamage( ability )

	local anim = self:GetSequenceName(self.Owner:GetViewModel():GetSequence())
	self.Owner:LagCompensation( true )
	local tr = util.TraceLine( {
		start = self.Owner:GetShootPos(),
		endpos = self.Owner:GetShootPos() + self.Owner:GetAimVector() * self.HitDistance,
		filter = self.Owner,
		mask = MASK_SHOT_HULL
	} )

	if ( !IsValid( tr.Entity ) ) then
		tr = util.TraceHull( {
			start = self.Owner:GetShootPos(),
			endpos = self.Owner:GetShootPos() + self.Owner:GetAimVector() * self.HitDistance,
			filter = self.Owner,
			mins = Vector( -10, -10, -8 ),
			maxs = Vector( 10, 10, 8 ),
			mask = MASK_SHOT_HULL
		} )

	end

	-- We need the second part for single player because SWEP:Think is ran shared in SP
	if ( tr.Hit && !( game.SinglePlayer() && CLIENT ) ) then
		self:EmitSound( HitSound )
	end

	self.Hit = false

	if ( SERVER && IsValid( tr.Entity ) && ( tr.Entity:IsNPC() || tr.Entity:IsPlayer() || tr.Entity:Health() > 0 ) ) then
		
		local dmginfo = DamageInfo()
		local attacker = self.Owner
		if ( !IsValid( attacker ) ) then attacker = self end

		dmginfo:SetAttacker( attacker )
		dmginfo:SetInflictor( self )
		dmginfo:SetDamage( self.Primary.Damage * self.ModDmg )

		if ( anim == "fists_left" ) then
			dmginfo:SetDamageForce( self.Owner:GetRight() * 4912 + self.Owner:GetForward() * 9998 ) -- Yes we need those specific numbers
		elseif ( anim == "fists_right" ) then
			dmginfo:SetDamageForce( self.Owner:GetRight() * -4912 + self.Owner:GetForward() * 9989 )
		elseif ( anim == "fists_uppercut" ) then
			dmginfo:SetDamageForce( self.Owner:GetUp() * 5158 + self.Owner:GetForward() * 10012 )
			dmginfo:SetDamage( self.Primary.DamageUppercut * self.ModDmg )
		end
		
		if ability then
			if ability == ASWEP_Ability_ScornMark then
				self:ScornMark( tr.Entity )
				dmginfo:SetDamage( MAS.Ability.ScornMk.Damage * self.ModDmg )
			end
		end

		tr.Entity:TakeDamageInfo( dmginfo )
		
		self.Hit = true

	end // end if Server & Entity

	if ( SERVER && IsValid( tr.Entity ) ) then
	
		local phys = tr.Entity:GetPhysicsObject()
		if ( IsValid( phys ) ) then
			phys:ApplyForceOffset( self.Owner:GetAimVector() * 80 * phys:GetMass(), tr.HitPos )
		end

	end

	if ( SERVER ) then
		if ( self.Hit ) then
			local ply = self.Owner
			local charge = self:GetCharge() + 1
			local combo = self:GetCombo()
			self:SetCombo( combo + 1 )
			self:SetCharge( charge )
			self.HitTime = CurTime()
			
			// Heal on Hit
			local health = ply:Health() + 1 * self.ModDmg
			if (ply:GetMaxHealth() < health) then health = ply:GetMaxHealth() end
			if (ply:Health() > health) then health = ply:Health() end
			ply:SetHealth(health)
			
			// Heal on Kill
			if tr.Entity:Health() <= 0 then
				local health = ply:Health() + 4 * self.ModDmg
				self:SetCharge( charge + 5 )
				if (ply:GetMaxHealth() < health) then health = ply:GetMaxHealth() end
				if (ply:Health() > health) then health = ply:Health() end
				ply:SetHealth(health)
			end
			
		end // end If Hit
	end // end If Server

	self.Owner:LagCompensation( false )

end // end DealDamage Function

//// SCORN MARK Debuff ////
function SWEP:ScornMark( target )
	
	local ply	=	self.Owner
	local CD	=	self:GetA1_CD()
	
	if SERVER then
		if ply:IsValid() and ply:Alive() and CD > 0 and target:IsValid() and target:Health() > 0 then
			
			// Get the Target's original values
			local Mult = 0.5
			local T_SGravity = target:GetGravity()
			local T_SRunSpeed, T_SWalkSpeed
			target:SetGravity( T_SGravity / Mult )
			if target:IsPlayer() then
				T_SRunSpeed = target:GetRunSpeed()
				T_SWalkSpeed = target:GetWalkSpeed()
			// Set the Target's new values
				target:SetWalkSpeed( T_SWalkSpeed * Mult )
				target:SetRunSpeed( T_SRunSpeed * Mult )
			end
			
			//Effect
			local Origin = target:GetPos() + Vector(0,0,1)
			playEffect( Origin, target, 1, "VortDispel" )
			playEffect( Origin, target, 1, "StriderBlood" )
			target:EmitSound( MAS.Ability.ScornMk.SoundHit )
			
			// Deal extra damage on future hits
			hook.Add( "EntityTakeDamage", "MAS.Ability.ScornMark.Debuff".. ply:EntIndex() .. "." .. target:EntIndex(), function( ent, dmginfo )
				if ent == target and dmginfo:GetAttacker() == ply and dmginfo:GetInflictor() == self then
					local dmg = dmginfo:GetDamage() * MAS.Ability.ScornMk.DmgMul
					dmginfo:SetDamage( dmg )
				end
			end) // end Hook
			
			// Set the Target's normal values
			local dur = MAS.Ability.ScornMk.Duration
			timer.Create( "MAS.Ability.ScornMark.Debuff".. ply:EntIndex() .. "." .. target:EntIndex(), dur, 1, function()
				hook.Remove( "EntityTakeDamage", "MAS.Ability.ScornMark.Debuff".. ply:EntIndex() .. "." .. target:EntIndex() )
				if target:IsValid() and target:Health() > 0 then
					target:SetGravity( T_SGravity )
					if target:IsPlayer() then
						target:SetWalkSpeed( T_SWalkSpeed )
						target:SetRunSpeed( T_SRunSpeed )
					end
				end // end if valid
			end) // end timer
			
		end // end Checks
	end // end If Server
	
end // end ScornMark Ability

//// VETERAN STRENGTH Buff ////
function SWEP:VeteranStrength( ply, self, SWEP )
	-- Heal self & gain extra damage
	local ply	=	ply or SWEP.Owner
	local CD	=	SWEP:GetA3_CD()
	
	if SERVER then
		if ply:IsValid() and ply:Alive() and CD > 0 then
			
			// Set future variables
			local dmgmul	=	MAS.Ability.VetSt.DmgMul	-- damage mul
			local ls 		= 	MAS.Ability.VetSt.LSMul 	-- hp LS
			local als 		= 	MAS.Ability.VetSt.ALS 		-- armor LS
			local heal 		= 	MAS.Ability.VetSt.Heal 		-- Heal on Use
			
			// Heal on Use
			local health = ply:Health() + heal
			if (ply:GetMaxHealth() < health) then -- if HP full, do nothing
				health = ply:GetMaxHealth()
			end
			ply:SetHealth(health)
			
			// Deal extra damage on future hits
			hook.Add( "EntityTakeDamage", "MAS.Ability.VeteranStrength.Buff"..ply:EntIndex(), function( ent, dmginfo )
				if dmginfo:GetAttacker() == ply and dmginfo:GetInflictor() == self then
					local dmg = dmginfo:GetDamage() * dmgmul
					dmginfo:SetDamage( dmg )
					
					// Heal on Hit
					if ply:IsValid() and ply:Alive() then
						
						local health = ply:Health() + dmg * ls
						if (ply:GetMaxHealth() < health) then -- if HP full, overcharge to shield!
							health = ply:GetMaxHealth() 
							if (ply:Health() > health) then health = ply:Health() end
							local armor = ply:Armor() + als
							ply:SetArmor(armor)
						end
						ply:SetHealth(health)
					end
				end
			end) // end Hook
			
			// Set the Target's normal values
			local dur = MAS.Ability.VetSt.Duration
			timer.Create( "MAS.Ability.VeteranStrength.Buff" .. ply:EntIndex(), dur, 1, function()
				hook.Remove( "EntityTakeDamage", "MAS.Ability.VeteranStrength.Buff"..ply:EntIndex() )
			end) // end timer
			
		end // end Checks
	end // end If Server
	
end // end ScornMark Ability


///// ULTIMATE ABILITY /////
function SWEP:Ult( ply )
	return
end

// Dropped Weapon
function SWEP:OnDrop()

	self:Remove() -- You can't drop fists

end

// Holster
function SWEP:Holster()
	-- Prevent abilities from working if weapon switched to prevent abuse
	if SERVER and ( self:GetA2_Active() or self:GetAU_Active() ) then
		self.Owner:ChatPrint( "[MAS] Fists of Reprisal: Ability Canceled - Weapon Switched")
	end
	reloadToggle = false
	self:SetCastOnLand( false )
	self:SetA2_Active( false )
	self:SetAU_Active( false )
	self:SetIsCasting( false )
	return true
	
end

// Weapon Info
function SWEP:PrintWeaponInfo(x, y, alpha)

	if (self.DrawWeaponInfoBox == false) then return end

	if (self.InfoMarkup == nil) then
		local str
		local title_color = "<color = 255, 200, 0, 255>"
		local hl_color = "<color = 247, 168, 32, 200>"
		local text_color = "<color = 255, 255, 255, 200>"
		
		str = "<font=DermaDefaultBold>"
		if (self.Author != "") then str = str .. title_color .. "Author:</color>\t" .. text_color .. self.Author .. "</color>\n" end
		if (self.Contact != "") then str = str .. title_color .. "Contact:</color>\t" .. text_color .. self.Contact .. "</color>\n\n" end
		if (self.Purpose != "") then str = str .. title_color .. "Purpose:</color>\n" .. text_color .. self.Purpose .. "</color>\n\n" end

		-- Set the instructions
		if (self.Instructions != "") then str = str .. title_color .. "Instructions:</color>\n"
			local myInstr = self.Instr
			for i = 1, table.Count(myInstr) do
				local HL = myInstr["H"..i]
				local TL = myInstr[""..i]
				if ( HL != nil ) then
					str = str .. hl_color .. HL .. text_color .. TL .. "\n"
					table.remove( myInstr, i )
					table.remove( myInstr, tostring(i) )
				elseif TL != nil then -- If No Headline, then Check Text Line
					str = str .. text_color .. TL .. "\n"
				end
			end
		end // end of Instructions
		str = str .. "</font>"
		
		self.InfoMarkup = markup.Parse(str, 250)
	end
	
	local outerColor 	= 	Color( 0, 100, 165, 255 )
	local innerColor 	= 	Color( 0, 130, 200, 255 )
	
	surface.SetDrawColor(outerColor)
	surface.SetTexture(self.SpeechBubbleLid)
	surface.DrawTexturedRect(x, y - 69.5, 128, 64) 
	draw.RoundedBox(8, x - 5, y - 6, 260, self.InfoMarkup:GetHeight() + 18, outerColor)
	draw.RoundedBox(8, x - 2, y - 3, 254, self.InfoMarkup:GetHeight() + 12, innerColor)
	
	self.InfoMarkup:Draw(x + 5, y + 5, nil, nil, alpha)
end

// Deployed Weapon
function SWEP:Deploy()
	
	local speed = GetConVarNumber( "sv_defaultdeployspeed" ) or 1
	local vm = self.Owner:GetViewModel()
	vm:SetPlaybackRate( speed )
	vm:SendViewModelMatchingSequence( vm:LookupSequence( "fists_draw" ) )
	local dur = vm:SequenceDuration() / speed
	self:SetNextPrimaryFire( CurTime() + dur )
	self:SetNextSecondaryFire( CurTime() + dur )
	self:UpdateNextIdle()

	if ( SERVER ) then
		self:SetCombo( 0 )
	else // Client
		self.DrawCrosshair		= 	GetConVar( "cl_mas_crosshairon" ):GetBool()
	end
	
	return true

end // end Fn Deploy

// Weapons Think Too
function SWEP:Think()
	
	local ply = self.Owner
	local vm = self.Owner:GetViewModel()
	local curtime = CurTime()
	local idletime = self:GetNextIdle()
	
	if CLIENT and game.SinglePlayer() then -- is SinglePlayer
		
		if !vgui.CursorVisible() and !vgui.GetKeyboardFocus() and self.KB then -- Not in menu, Key table exists
		
			local Wep = ply:GetActiveWeapon()
			if !( ply:IsValid() and ply:Alive() and Wep:IsValid() and Wep:GetClass() == "weapon_fistsofreprisal" ) then return end
			
			for btn, ability in pairs( self.KB["Btn"] ) do
				if ability != 1 and ability != 2 then
					if ( input.IsButtonDown( btn ) ) and !table.HasValue( keysDown, btn ) then
						table.insert( keysDown, btn )
						
						if ( ply:IsValid() and ply:Alive() and Wep:IsValid() and Wep:GetClass() == "weapon_fistsofreprisal" ) then
							-- AutoAttack & Ability #1:Scorn Mark are bound to +attack & +attack2 by default & won't trigger anything here.
							
							if ability == ASWEP_Ability_VengefulLeap then 
							// Abil 2: Vengeful Leap
								if ( self:GetIsCasting() or self:GetA2_CD() != 0 ) then 
									return 
								end
								local ability = ASWEP_Ability_VengefulLeap
								local CD = MAS.Ability.VengLp.Cooldown
								self:SetA2_Active( true )
								self:SetIsCasting( true )
								self:SetA2_CD( CD )
							
								-- Launch!
								local vel = ply:GetAimVector()
								local forcemul = MAS.Ability.VengLp.ForceMul
								if vel.z > 0.5 then vel.z = vel.z * 0.8 end
								ply:SetPos( ply:GetPos() + Vector( 0, 0, 3 ) )
								ply:SetVelocity( vel * forcemul + ply:GetUp() * 30 )
								
								net.Start( "Maranzo_AbilitySWEP_FistsOfReprisal_Cast" )
								net.WriteInt( ability, 4 )
								net.SendToServer()
								
							elseif ability == ASWEP_Ability_VeteranStrength then 
							// Abil 3: Veteran Strength
								if ( self:GetIsCasting() or self:GetA3_CD() != 0 ) then 
									return 
								end
								local CD = MAS.Ability.VetSt.Cooldown
								self:SetA3_Active( true )
								self:SetIsCasting( true )
								self:SetA3_CD( CD )
								
								local ability = ASWEP_Ability_VeteranStrength
								
								net.Start( "Maranzo_AbilitySWEP_FistsOfReprisal_Cast" )
								net.WriteInt( ability, 4 )
								net.SendToServer()
								
							end // end Key Check
							
							if ability == ASWEP_Ability_Select then
							// Ability Selection
								self:DrawAbilitySelection()
								
							end // end Key check, cursor visible OK <-- Not set currently for SP
							
						end // end if ply & alive & weapon
						
					elseif !( input.IsButtonDown( btn ) ) and table.HasValue( keysDown, btn ) then
						table.RemoveByValue( keysDown, btn )
					end // end Btn Release
				end // end AutoAttack & Ability 1 check
			end // end For Btn check
		end // end  if !Mouse Visible
	end // end SinglePlayer
	
	if ( idletime > 0 && curtime > idletime ) then
		
		vm:SendViewModelMatchingSequence( vm:LookupSequence( "fists_idle_0" .. math.random( 1, 2 ) ) )
		self:UpdateNextIdle()
	
	end

	local meleetime = self:GetNextMeleeAttack()
	if ( meleetime > 0 && curtime > meleetime ) then

		self:SetNextMeleeAttack( 0 )
		self:SetAA_Active( false )
		
		-- If Ability 1: Scorn Mark
		if ( self:GetA1_Active() ) then 
			
			-- Do Scorn Mark
			self:DealDamage( ASWEP_Ability_ScornMark )
			self:SetA1_Active( false )
			local CD = self:GetA1_CD()
			local itCD = CD
			timer.Create( "MAS.Ability.ScornMark.CD" .. ply:EntIndex(), 1, itCD, function()
				if self:IsValid() then
					CD = CD - 1
					self:SetA1_CD( CD )
				else
					timer.Remove( "MAS.Ability.ScornMark.CD" .. ply:EntIndex() )
				end
			end)
			
		else // end if an ability
			self:DealDamage()
		end

	end
	
	if (SERVER) then
		
		// Set up Variables across the board
		local CastOnLand = self:GetCastOnLand()
		
		// Vengeful Leap
		if self:GetA2_Active() then
		
			if CastOnLand then
				
				local Landed = ply:OnGround()
				
				if Landed then
					local insphere = ents.FindInSphere( ply:GetPos(), 200 )
					local targets = {}
					
					local dmginfo = DamageInfo()
					local attacker = self.Owner
					if ( !IsValid( attacker ) ) then attacker = self end
					
			
					dmginfo:SetAttacker( attacker )
					dmginfo:SetInflictor( self )
					dmginfo:SetDamage( MAS.Ability.VengLp.Damage )
					
					local origin = ply:GetPos()
					local forcemul = MAS.Ability.VengLp.ForceMul
					
					for k, v in ipairs(insphere) do
						if (!v:Health() or v:Health() == 0 or v == ply) and v:GetClass() != "prop_physics" then continue end
						table.insert(targets,v)
						
						-- Damage!
						local entpos	=	v:GetPos()
						local dist 		=	math.Clamp((math.Distance(origin.x, origin.y, entpos.x, entpos.y) / 100), 1, 100)
						local force 	= 	(-(origin - entpos):GetNormalized() * forcemul*0.4 + Vector(0,0,300) ) / dist
						if (v:GetClass()=="prop_physics" and v:GetPhysicsObject():IsValid()) then 
							v:GetPhysicsObject():SetVelocity( force / 5 )
						else 
							dmginfo:SetDamageForce( force )
							v:TakeDamageInfo( dmginfo )
							if v:GetClass() == "npc_strider" then force = Vector( 0, 0, 0 ) end -- prevent striders fly glitch
							v:SetVelocity( force ) 
						end
					end
					
					-- Effect & Sound
					local Origin = ply:GetPos() + Vector( 0, 0, 1)
					playEffect( Origin, ply, 1, "WheelDust", 5, 1, 1 )
					playEffect( Origin, ply, 1, "ThumperDust", 2, 100, 1 )
					ply:EmitSound( MAS.Ability.VengLp.SoundLand )
					-- Turn it off
					self:SetA2_Active( false )
					self:SetIsCasting( false )
					self:SetCastOnLand( false )
					hook.Remove( "EntityTakeDamage", "MAS.FistsOfReprisal.OnTakeFallDamage" .. ply:EntIndex() )
				
				end // end on ground
				
			end // end Cast on Land
					
		end // end Ability 2: Vengeful Leap
		
		// Ultimate
		if self:GetAU_Active() then
			if ( !CastOnLand ) then
				local vel = ply:GetVelocity()
				ply:SetVelocity( -vel )
			elseif ( CastOnLand ) then
				
				local Landed = ply:OnGround()
				
				if Landed then
					local insphere = ents.FindInSphere( ply:GetPos(), 200 )
					local targets = {}
					
				local dmginfo = DamageInfo()
				local attacker = self.Owner
				if ( !IsValid( attacker ) ) then attacker = self end
		
				dmginfo:SetAttacker( attacker )
				dmginfo:SetInflictor( self )
				dmginfo:SetDamage( MAS.Ability.MeteorDv.Damage * self.ModDmg )
				
				local origin = ply:GetPos()
				
				for k, v in ipairs(insphere) do
					if (!v:Health() or v:Health() == 0 or v == ply) and v:GetClass() != "prop_physics" then continue end
					
					-- Damage!
					local entpos	=	v:GetPos()
					local dist 		=	math.Clamp((math.Distance(origin.x, origin.y, entpos.x, entpos.y) / 100), 1, 100)
					local force 	= 	(-(origin - entpos):GetNormalized() * 1500 + Vector(0,0,300) ) / dist
					local rand		=	math.random(1,3)
					if (v:GetClass()=="prop_physics" and v:GetPhysicsObject():IsValid()) then 
						v:GetPhysicsObject():SetVelocity( force / 5 )
					else 
						if rand == 1 then playEffect( entpos, v, 1, "Explosion" ) end
						dmginfo:SetDamageForce( force )
						v:TakeDamageInfo( dmginfo )
						if v:GetClass() == "npc_strider" then force = Vector( 0, 0, 0 ) end -- prevent striders fly glitch
						v:SetVelocity( force ) 
						table.insert(targets,v)
					end
				end
				
				self:SetCharge( self:GetCharge() + math.Round(3 * self.ModDmg * #targets) )
				self:SetCombo(#targets * 5)
				self.HitTime = curtime + 5
				-- Effect!
				local Origin = ply:GetPos() + Vector( 0, 0, 5 )
				playEffect( Origin, ply, 1, "ThumperDust", 1, -20 )
				playEffect( Origin, ply, 1, "ThumperDust", 1, 200 )
				playEffect( Origin, ply, 1, "Explosion" )
				ply:EmitSound( MAS.Ability.MeteorDv.SoundLand )
				ply:EmitSound( MAS.Ability.MeteorDv.SoundLand2 )
				-- Values off
				self:SetCastOnLand( false )
				self:SetAU_Active( false )
				self:SetIsCasting( false )
				hook.Remove("EntityTakeDamage", "MAS.Ability.MeteorDive.OnTakeDamage" .. ply:EntIndex())
					
				end // if on ground
			end // end if Abil on Land
		end // end if Ult Active
		
		
		
		if ( curtime > self.HitTime + 1 ) then
	
			self:SetCombo( 0 )
			self.ModDelay = 1
			self.ModDmg = 1
	
		end
		
	end // End if Server
	
end // end SWEP think


----------------------------------------------------------------------
---- Net Usage

if (SERVER) then
	
	util.AddNetworkString( "Maranzo_AbilitySWEP_FistsOfReprisal_Cast" )
	util.AddNetworkString( "Maranzo_AbilitySWEP_FistsOfReprisal_CastCancel" )

	// Run the real ability server-side
	net.Receive( "Maranzo_AbilitySWEP_FistsOfReprisal_Cast", function( len, ply )
		
		if ( IsValid( ply ) and ply:Alive() and ply:GetActiveWeapon():GetClass() == "weapon_fistsofreprisal" ) then
			local ability = net.ReadInt( 4 )
			local Wep = ply:GetActiveWeapon()
			local SWEP = Wep:GetTable()
				
			if ability == ASWEP_Ability_VengefulLeap then 
				if ( !SWEP:GetA2_Active() and !SWEP:GetIsCasting() and SWEP:GetA2_CD() == 0 ) then 
					-- Prevent more abilities
					SWEP:SetA2_Active( true )
					SWEP:SetIsCasting( true )
					
					-- Launch!
					local vel = ply:GetAimVector()
					local forcemul = MAS.Ability.VengLp.ForceMul
					if vel.z > 0.5 then vel.z = vel.z * 0.8 end
					ply:SetPos( ply:GetPos() + Vector( 0, 0, 3 ) )
					ply:SetVelocity( vel * forcemul + ply:GetUp() * 30 )
					ply:EmitSound( MAS.Ability.VengLp.Sound1 )
					local Origin = ply:GetPos() + Vector( 0, 0, 5)
					playEffect( Origin, ply, 1, "WheelDust", 5 )
						
					hook.Add("EntityTakeDamage", "MAS.FistsOfReprisal.OnTakeFallDamage" .. ply:EntIndex(), function( ent, DmgInfo )
			
						if ent == ply then
							if Wep:IsValid() and SWEP:GetA2_Active() then 
								if DmgInfo:IsFallDamage() then DmgInfo:SetDamage( 0 ) end
							else 
								hook.Remove( "EntityTakeDamage", "MAS.FistsOfReprisal.OnTakeFallDamage" .. ply:EntIndex() )
								return
							end
						end
					end)
					
					-- Ability Activates
					timer.Simple( 0.1, function() 
						if Wep:IsValid() then 
							SWEP:SetCastOnLand( true )
						end
					end )
					
					-- Cooldown Active
					local CD = MAS.Ability.VengLp.Cooldown
					SWEP:SetA2_CD( CD )
					local itCD = CD
					timer.Create( "MAS.Ability.VengefulLeap.CD" .. ply:EntIndex(), 1, itCD, function()
						if Wep:IsValid() then
							CD = CD - 1
							SWEP:SetA2_CD( CD )
						else
							timer.Remove( "MAS.Ability.VengefulLeap.CD" .. ply:EntIndex() )
						end
					end)
					
					-- Let the player know CD Active
					net.Start( "Maranzo_AbilitySWEP_FistsOfReprisal_Cast" )
					net.WriteInt( ability, 4 )
					net.Send( ply )
					
				end
				
			elseif ability == ASWEP_Ability_VeteranStrength then 
				
				if ( !SWEP:GetA3_Active() and !SWEP:GetIsCasting() and SWEP:GetA3_CD() == 0 ) then
					
					-- Activate Veteran Strength ability ( May be used with others )
					SWEP:SetA3_Active( true )
					ply:EmitSound( MAS.Ability.VetSt.Sound1 )
					local CD = MAS.Ability.VetSt.Cooldown
					SWEP:SetA3_CD( CD )
					SWEP:VeteranStrength( ply, Wep, SWEP )
					
					-- Deactivate ability
					local dur = MAS.Ability.VetSt.Duration
					timer.Simple( dur, function() 
						if Wep:IsValid() then 
							SWEP:SetA3_Active( false ) 
						end
					end )
					
					-- Countdown CD on server
					local itCD = CD
					timer.Create( "MAS.Ability.VeteranStrength.CD" .. ply:EntIndex() , 1, itCD, function()
						if Wep:IsValid() then
							CD = CD - 1
							SWEP:SetA3_CD( CD )
						else
							timer.Remove( "MAS.Ability.VeteranStrength.CD" .. ply:EntIndex() )
						end
					end)
					
					-- Tell ply to countdown CD if server lags
					net.Start( "Maranzo_AbilitySWEP_FistsOfReprisal_Cast" )
					net.WriteInt( ability, 4 )
					net.Send( ply )
				end
				
				
			end
			
		end // end If Ply & Weapon
		
	end ) // end Net Receive
	
end

if (CLIENT) then

	net.Receive( "Maranzo_AbilitySWEP_FistsOfReprisal_Cast", function( len, ply )
		
		local ply = LocalPlayer()
		local Wep = ply:GetActiveWeapon()
		local SWEP = Wep:GetTable()
		
		if ( IsValid( ply ) and ply:Alive() and ply:GetActiveWeapon():GetClass() == "weapon_fistsofreprisal" ) then
			local ability = net.ReadInt( 4 )
			
			if ability == ASWEP_Ability_VengefulLeap then 
				timer.Simple( 0.1, function()
					if Wep:IsValid() then
						
						-- Countdown CD
						local CD = SWEP:GetA2_CD()
						local itCD = CD
						timer.Create( "MAS.Ability.VengefulLeap.CD" .. ply:EntIndex(), 1, itCD, function()
							if Wep:IsValid() then
								CD = CD - 1
								SWEP:SetA2_CD( CD )
							end
						end)
						
					end
				end)
				
				
			elseif ability == ASWEP_Ability_VeteranStrength then 
				timer.Simple( 0.1, function()
					if Wep:IsValid() then
					
						-- Deactivate Ability
						local dur = MAS.Ability.VetSt.Duration
						timer.Simple( dur, function() 
							if Wep:IsValid() then 
								SWEP:SetA3_Active( false ) 
							end
						end )
						
						-- Countdown CD
						local CD = SWEP:GetA3_CD()
						local itCD = CD
						timer.Create( "MAS.Ability.Strength.CD" .. ply:EntIndex(), 1, itCD, function()
							if Wep:IsValid() then
								CD = CD - 1
								SWEP:SetA3_CD( CD )
							end
						end)
					end
				end)
					
			end
			
		end // end If Ply & Weapon
		
	end ) // end Net Receive
	
	
	
end